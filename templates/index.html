<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¯ãƒ©ã‚¦ãƒãƒ³ã‚°ã‚¹ã‚¿ãƒ¼ãƒˆå§¿å‹¢åˆ†æ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', 'Meiryo UI', sans-serif;
            background-color: #f8f9fa;
        }
        .header {
            background-color: #6c5ce7;
            color: white;
            padding: 20px 0;
            margin-bottom: 20px;
        }
        .upload-section {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .image-container {
            position: relative;
            width: 100%;
            min-height: 300px;
            border: 1px solid #ddd;
            margin-top: 20px;
            background-color: #f8f9fa;
        }
        #preview-image {
            max-width: 100%;
            max-height: 600px;
            display: none;
        }
        .joint-point {
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: red;
            border: 2px solid white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: move;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }
        .joint-line {
            position: absolute;
            height: 3px;
            background-color: red;
            transform-origin: left center;
        }
        .controls-section {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .joint-btn {
            margin: 5px;
            padding: 8px 12px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
        }
        .joint-btn.active {
            background-color: #6c5ce7;
            color: white;
        }
        .analysis-section {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1 class="text-center">ğŸƒ ã‚¯ãƒ©ã‚¦ãƒãƒ³ã‚°ã‚¹ã‚¿ãƒ¼ãƒˆå§¿å‹¢åˆ†æ</h1>
            <p class="text-center">ãƒãƒ¼ãƒ å…±æœ‰å¯¾å¿œãƒ»æœ¬æ ¼åˆ†æãƒ„ãƒ¼ãƒ«</p>
        </div>
    </div>

    <div class="container">
        <div class="row">
            <div class="col-lg-8">
                <div class="upload-section">
                    <h4>ğŸ“· ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h4>
                    
                    <!-- é€šå¸¸ã®HTMLãƒ•ã‚©ãƒ¼ãƒ  -->
                    <form id="upload-form" enctype="multipart/form-data">
                        <div class="mb-3">
                            <input type="file" class="form-control" id="image-input" name="file" accept="image/*">
                        </div>
                        <button type="submit" class="btn btn-primary">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
                    </form>
                    
                    <div id="image-container" class="image-container">
                        <img id="preview-image" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
                        <!-- é–¢ç¯€ç‚¹ã¨ç·šã¯JSã§è¿½åŠ  -->
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="controls-section">
                    <h4>ğŸ¯ é–¢ç¯€ç‚¹èª¿æ•´</h4>
                    
                    <div id="joint-buttons" class="d-flex flex-wrap">
                        <button class="joint-btn" data-joint="LShoulder">â‘  å·¦è‚©</button>
                        <button class="joint-btn" data-joint="RShoulder">â‘¡ å³è‚©</button>
                        <button class="joint-btn" data-joint="C7">â‘¢ C7</button>
                        <button class="joint-btn" data-joint="LHip">â‘£ å·¦è…°</button>
                        <button class="joint-btn" data-joint="RHip">â‘¤ å³è…°</button>
                        <button class="joint-btn" data-joint="LKnee">â‘¥ å·¦è†</button>
                        <button class="joint-btn" data-joint="RKnee">â‘¦ å³è†</button>
                        <button class="joint-btn" data-joint="LAnkle">â‘§ å·¦è¶³é¦–</button>
                        <button class="joint-btn" data-joint="RAnkle">â‘¨ å³è¶³é¦–</button>
                    </div>
                    
                    <div class="mt-4">
                        <p>é¸æŠä¸­: <span id="selected-joint">ãªã—</span></p>
                        
                        <div class="mt-4">
                            <button id="analyze-set-btn" class="btn btn-success w-100 mb-2">ğŸƒ ã‚»ãƒƒãƒˆå§¿å‹¢åˆ†æ</button>
                            <button id="analyze-takeoff-btn" class="btn btn-info w-100 text-white">ğŸš€ é£›ã³å‡ºã—åˆ†æ</button>
                        </div>
                    </div>
                </div>
                
                <div id="analysis-section" class="analysis-section" style="display:none;">
                    <h4>ğŸ“Š åˆ†æçµæœ</h4>
                    <div id="angle-results">
                        <!-- çµæœã¯JSã§è¿½åŠ  -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOMè¦ç´ 
            const form = document.getElementById('upload-form');
            const imageInput = document.getElementById('image-input');
            const previewImage = document.getElementById('preview-image');
            const imageContainer = document.getElementById('image-container');
            const jointButtons = document.querySelectorAll('.joint-btn');
            const selectedJointText = document.getElementById('selected-joint');
            const analyzeSetBtn = document.getElementById('analyze-set-btn');
            const analyzeTakeoffBtn = document.getElementById('analyze-takeoff-btn');
            const analysisSection = document.getElementById('analysis-section');
            const angleResults = document.getElementById('angle-results');
            
            // çŠ¶æ…‹å¤‰æ•°
            let keypoints = {};
            let selectedJoint = null;
            let imageWidth = 0;
            let imageHeight = 0;
            
            // é–¢ç¯€ç‚¹ã®è¡¨ç¤ºå
            const jointNames = {
                'LShoulder': 'â‘  å·¦è‚©',
                'RShoulder': 'â‘¡ å³è‚©',
                'C7': 'â‘¢ C7',
                'LHip': 'â‘£ å·¦è…°',
                'RHip': 'â‘¤ å³è…°',
                'LKnee': 'â‘¥ å·¦è†',
                'RKnee': 'â‘¦ å³è†',
                'LAnkle': 'â‘§ å·¦è¶³é¦–',
                'RAnkle': 'â‘¨ å³è¶³é¦–'
            };
            
            // é–¢ç¯€ç‚¹é–“ã®æ¥ç¶šå®šç¾©
            const jointConnections = [
                ['LShoulder', 'LHip'], ['LHip', 'LKnee'], ['LKnee', 'LAnkle'],
                ['RShoulder', 'RHip'], ['RHip', 'RKnee'], ['RKnee', 'RAnkle'],
                ['LShoulder', 'RShoulder'], ['LHip', 'RHip'],
                ['LShoulder', 'C7'], ['RShoulder', 'C7']
            ];
            
            // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆ
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const file = imageInput.files[0];
                if (!file) {
                    alert('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                    return;
                }
                
                // FormDataä½œæˆ
                const formData = new FormData();
                formData.append('file', file);
                
                // é€ä¿¡
                fetch('/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // ç”»åƒè¡¨ç¤º
                        previewImage.src = data.image_url;
                        previewImage.style.display = 'block';
                        
                        // æƒ…å ±ä¿å­˜
                        keypoints = data.keypoints;
                        imageWidth = data.image_width;
                        imageHeight = data.image_height;
                        
                        // é–¢ç¯€ç‚¹æç”»
                        renderJointPoints();
                    } else {
                        alert(data.error || 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—');
                    }
                })
                .catch(error => {
                    console.error('ã‚¨ãƒ©ãƒ¼:', error);
                    alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                });
            });
            
            // é–¢ç¯€ç‚¹æç”»
            function renderJointPoints() {
                // æ—¢å­˜ã®ç‚¹ã¨ç·šã‚’å‰Šé™¤
                clearJointElements();
                
                // é–¢ç¯€ç‚¹ã¨ç·šã‚’æç”»
                renderJointLines();
                
                for (const jointName in keypoints) {
                    const point = keypoints[jointName];
                    
                    // ã‚¹ã‚±ãƒ¼ãƒ«èª¿æ•´
                    const containerRect = imageContainer.getBoundingClientRect();
                    const scaleX = previewImage.width / imageWidth;
                    const scaleY = previewImage.height / imageHeight;
                    
                    // é–¢ç¯€ç‚¹è¦ç´ ã®ä½œæˆ
                    const jointElement = document.createElement('div');
                    jointElement.className = 'joint-point';
                    if (jointName === selectedJoint) {
                        jointElement.classList.add('active');
                    }
                    
                    // ç•ªå·è¡¨ç¤º
                    const jointNumber = jointName.replace(/[^0-9]/g, '');
                    jointElement.textContent = jointNames[jointName].charAt(0);
                    
                    // ä½ç½®è¨­å®š
                    jointElement.style.left = `${point.x * scaleX}px`;
                    jointElement.style.top = `${point.y * scaleY}px`;
                    jointElement.setAttribute('data-joint', jointName);
                    
                    // ãƒ‰ãƒ©ãƒƒã‚°å‡¦ç†
                    jointElement.addEventListener('mousedown', function(e) {
                        e.preventDefault();
                        const jointName = this.getAttribute('data-joint');
                        selectJoint(jointName);
                        
                        const startX = e.clientX;
                        const startY = e.clientY;
                        const startLeft = parseInt(this.style.left);
                        const startTop = parseInt(this.style.top);
                        
                        function moveJoint(e) {
                            const dx = e.clientX - startX;
                            const dy = e.clientY - startY;
                            
                            const newX = Math.max(0, Math.min(startLeft + dx, previewImage.width));
                            const newY = Math.max(0, Math.min(startTop + dy, previewImage.height));
                            
                            jointElement.style.left = `${newX}px`;
                            jointElement.style.top = `${newY}px`;
                            
                            // åº§æ¨™æ›´æ–°
                            keypoints[jointName].x = newX / scaleX;
                            keypoints[jointName].y = newY / scaleY;
                            
                            // ç·šã®å†æç”»
                            renderJointLines();
                        }
                        
                        function stopMoving() {
                            document.removeEventListener('mousemove', moveJoint);
                            document.removeEventListener('mouseup', stopMoving);
                        }
                        
                        document.addEventListener('mousemove', moveJoint);
                        document.addEventListener('mouseup', stopMoving);
                    });
                    
                    // ã‚³ãƒ³ãƒ†ãƒŠã«è¿½åŠ 
                    imageContainer.appendChild(jointElement);
                }
                
                // ãƒœã‚¿ãƒ³ã®é¸æŠçŠ¶æ…‹æ›´æ–°
                updateJointButtons();
            }
            
            // é–¢ç¯€ç‚¹é–“ã®ç·šæç”»
            function renderJointLines() {
                // æ—¢å­˜ã®ç·šã‚’å‰Šé™¤
                document.querySelectorAll('.joint-line').forEach(el => el.remove());
                
                // ã‚¹ã‚±ãƒ¼ãƒ«å–å¾—
                const scaleX = previewImage.width / imageWidth;
                const scaleY = previewImage.height / imageHeight;
                
                jointConnections.forEach(connection => {
                    const [joint1, joint2] = connection;
                    
                    if (keypoints[joint1] && keypoints[joint2]) {
                        const p1 = {
                            x: keypoints[joint1].x * scaleX,
                            y: keypoints[joint1].y * scaleY
                        };
                        const p2 = {
                            x: keypoints[joint2].x * scaleX,
                            y: keypoints[joint2].y * scaleY
                        };
                        
                        // ç·šã®é•·ã•ã¨è§’åº¦
                        const length = Math.sqrt(Math.pow(p2.x - p1.x, 2) + Math.pow(p2.y - p1.y, 2));
                        const angle = Math.atan2(p2.y - p1.x, p2.x - p1.x) * (180 / Math.PI);
                        
                        // ç·šã®è¦ç´ 
                        const line = document.createElement('div');
                        line.className = 'joint-line';
                        line.style.left = `${p1.x}px`;
                        line.style.top = `${p1.y}px`;
                        line.style.width = `${length}px`;
                        line.style.transform = `rotate(${angle}deg)`;
                        
                        // C7ã®ç·šã¯åˆ¥è‰²
                        if (connection.includes('C7')) {
                            line.style.backgroundColor = 'blue';
                        }
                        
                        imageContainer.appendChild(line);
                    }
                });
            }
            
            // é–¢ç¯€ç‚¹é¸æŠ
            function selectJoint(jointName) {
                selectedJoint = jointName;
                selectedJointText.textContent = jointNames[jointName] || jointName;
                updateJointButtons();
                renderJointPoints();
            }
            
            // ãƒœã‚¿ãƒ³çŠ¶æ…‹æ›´æ–°
            function updateJointButtons() {
                jointButtons.forEach(btn => {
                    const jointName = btn.getAttribute('data-joint');
                    if (jointName === selectedJoint) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            }
            
            // é–¢ç¯€ç‚¹ã¨ç·šã‚¯ãƒªã‚¢
            function clearJointElements() {
                document.querySelectorAll('.joint-point, .joint-line').forEach(el => el.remove());
            }
            
            // é–¢ç¯€ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
            jointButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const jointName = this.getAttribute('data-joint');
                    selectJoint(jointName);
                });
            });
            
            // ã‚»ãƒƒãƒˆå§¿å‹¢åˆ†æ
            analyzeSetBtn.addEventListener('click', function() {
                fetch('/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        keypoints: keypoints,
                        mode: 'set'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayResults(data, 'set');
                    } else {
                        alert(data.error || 'åˆ†æã‚¨ãƒ©ãƒ¼');
                    }
                })
                .catch(error => {
                    alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + error.message);
                });
            });
            
            // é£›ã³å‡ºã—åˆ†æ
            analyzeTakeoffBtn.addEventListener('click', function() {
                fetch('/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        keypoints: keypoints,
                        mode: 'takeoff'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayResults(data, 'takeoff');
                    } else {
                        alert(data.error || 'åˆ†æã‚¨ãƒ©ãƒ¼');
                    }
                })
                .catch(error => {
                    alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + error.message);
                });
            });
            
            // çµæœè¡¨ç¤º
            function displayResults(data, mode) {
                analysisSection.style.display = 'block';
                angleResults.innerHTML = '';
                
                if (mode === 'set') {
                    if (data.front_angle) addResultItem('å‰è¶³è†è§’åº¦', data.front_angle);
                    if (data.rear_angle) addResultItem('å¾Œè¶³è†è§’åº¦', data.rear_angle);
                    if (data.front_hip_angle) addResultItem('å‰è¶³è‚¡é–¢ç¯€è§’åº¦', data.front_hip_angle);
                } else {
                    if (data.lower_angle) addResultItem('ä¸‹åŠèº«è§’åº¦', data.lower_angle);
                    if (data.upper_angle) addResultItem('ä¸ŠåŠèº«è§’åº¦', data.upper_angle);
                    if (data.kunoji_angle) addResultItem('ãã®å­—è§’åº¦', data.kunoji_angle);
                }
            }
            
            // çµæœé …ç›®è¿½åŠ 
            function addResultItem(name, value) {
                const item = document.createElement('div');
                item.className = 'mb-2';
                item.innerHTML = `<strong>${name}:</strong> ${value}Â°`;
                angleResults.appendChild(item);
            }
        });
    </script>
</body>
</html>
