<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèÉ „ÇØ„É©„Ç¶„ÉÅ„É≥„Ç∞„Çπ„Çø„É≥„ÇπÂàÜÊûê„Éó„É≠</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .dropzone {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s;
        }
        .dropzone.highlight {
            border-color: #007bff;
            background-color: rgba(0,123,255,0.1);
        }
        .joint-point {
            position: absolute;
            width: 12px;
            height: 12px;
            background-color: red;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: move;
            z-index: 10;
            border: 2px solid white;
        }
        .joint-line {
            position: absolute;
            background-color: yellow;
            height: 2px;
            transform-origin: left center;
            z-index: 5;
        }
        .angle-text {
            position: absolute;
            color: white;
            background-color: rgba(0,0,0,0.6);
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 12px;
            z-index: 15;
        }
        .control-panel {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .image-container {
            position: relative;
            margin: 15px 0;
            max-width: 100%;
            overflow: hidden;
        }
        #preview-image {
            max-width: 100%;
            display: none;
        }
        .mode-selector .btn {
            margin-right: 5px;
            margin-bottom: 5px;
        }
        .analysis-container {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        .feedback-item {
            margin: 5px 0;
            padding: 8px;
            border-radius: 4px;
            background-color: #e9ecef;
        }
        .arrow-controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr 1fr;
            width: 120px;
            margin: 10px auto;
        }
        .arrow-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        footer {
            margin-top: 40px;
            padding: 20px 0;
            background-color: #f8f9fa;
            text-align: center;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">üèÉ „ÇØ„É©„Ç¶„ÉÅ„É≥„Ç∞„Çπ„Çø„É≥„ÇπÂàÜÊûê„Éó„É≠</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#helpModal">
                            <i class="bi bi-question-circle"></i> ‰Ωø„ÅÑÊñπ
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="share-btn">
                            <i class="bi bi-share"></i> ÂÖ±Êúâ
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-lg-8">
                <!-- ÁîªÂÉè„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Ç®„É™„Ç¢ -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">üñºÔ∏è ÁîªÂÉè„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</h5>
                    </div>
                    <div class="card-body">
                        <div class="dropzone" id="upload-dropzone">
                            <p class="mb-2">ÁîªÂÉè„Çí„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó</p>
                            <p>„Åæ„Åü„ÅØ</p>
                            <input type="file" id="image-upload" class="d-none" accept="image/*">
                            <button class="btn btn-primary" onclick="document.getElementById('image-upload').click()">
                                <i class="bi bi-upload"></i> ÁîªÂÉè„ÇíÈÅ∏Êäû
                            </button>
                        </div>
                        <div class="mt-2 text-center" id="loading" style="display:none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p>ü§ñ AIÂàÜÊûê‰∏≠...</p>
                        </div>
                        <div class="alert alert-danger mt-3" id="error-message" style="display:none;"></div>
                    </div>
                </div>

                <!-- ÁîªÂÉè„Éó„É¨„Éì„É•„Éº„Å®Èñ¢ÁØÄÁÇπÁ∑®ÈõÜ„Ç®„É™„Ç¢ -->
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">üìê ÂßøÂã¢ÂàÜÊûê</h5>
                    </div>
                    <div class="card-body">
                        <div class="image-container" id="image-container">
                            <img id="preview-image" alt="„ÇØ„É©„Ç¶„ÉÅ„É≥„Ç∞ÂßøÂã¢">
                            <!-- Èñ¢ÁØÄÁÇπ„Å®„É©„Ç§„É≥„ÅØJS„ÅßÂãïÁöÑ„Å´ËøΩÂä† -->
                        </div>

                        <!-- Èñ¢ÁØÄÁÇπÁ∑®ÈõÜ„É¢„Éº„ÉâÈÅ∏Êäû -->
                        <div class="control-panel mt-3">
                            <h6>üî¢ Èñ¢ÁØÄÁÇπË™øÊï¥„É¢„Éº„Éâ:</h6>
                            <div class="mode-selector btn-group" role="group">
                                <button type="button" class="btn btn-outline-primary active" data-mode="click">
                                    ‚ù∂ „ÇØ„É™„ÉÉ„ÇØÈÅ∏Êäû
                                </button>
                                <button type="button" class="btn btn-outline-primary" data-mode="arrow">
                                    ‚ù∑ ÊñπÂêë„Ç≠„ÉºË™øÊï¥
                                </button>
                                <button type="button" class="btn btn-outline-primary" data-mode="dropdown">
                                    ‚ù∏ „Éó„É´„ÉÄ„Ç¶„É≥ÈÅ∏Êäû
                                </button>
                                <button type="button" class="btn btn-outline-primary" data-mode="all">
                                    ‚ùπ ‰∏ÄÊã¨Ë°®Á§∫
                                </button>
                            </div>

                            <!-- ÊñπÂêë„Ç≠„Éº„Ç≥„É≥„Éà„É≠„Éº„É´ („Ç¢„É≠„Éº„É¢„Éº„ÉâÁî®) -->
                            <div id="arrow-controls" class="mt-3" style="display:none;">
                                <div class="row">
                                    <div class="col-md-6">
                                        <select class="form-select mb-2" id="joint-selector">
                                            <option value="1">È†≠ÈÉ®</option>
                                            <option value="2">Âè≥ËÇ©</option>
                                            <option value="3">Âè≥ËÖ∞</option>
                                            <option value="4">Âè≥ËÜù</option>
                                            <option value="5">Â∑¶ËÜù</option>
                                            <option value="6">Âè≥Ë∂≥È¶ñ</option>
                                            <option value="7">Â∑¶Ë∂≥È¶ñ</option>
                                            <option value="8">Â∑¶ÊâãÈ¶ñ</option>
                                            <option value="9">Âè≥ÊâãÈ¶ñ</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="arrow-controls">
                                            <button class="btn btn-sm btn-light arrow-btn" data-dir="nw">‚Üñ</button>
                                            <button class="btn btn-sm btn-light arrow-btn" data-dir="n">‚Üë</button>
                                            <button class="btn btn-sm btn-light arrow-btn" data-dir="ne">‚Üó</button>
                                            <button class="btn btn-sm btn-light arrow-btn" data-dir="w">‚Üê</button>
                                            <button class="btn btn-sm btn-light arrow-btn" data-dir="c">‚Ä¢</button>
                                            <button class="btn btn-sm btn-light arrow-btn" data-dir="e">‚Üí</button>
                                            <button class="btn btn-sm btn-light arrow-btn" data-dir="sw">‚Üô</button>
                                            <button class="btn btn-sm btn-light arrow-btn" data-dir="s">‚Üì</button>
                                            <button class="btn btn-sm btn-light arrow-btn" data-dir="se">‚Üò</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- „Éó„É´„ÉÄ„Ç¶„É≥ÈÅ∏Êäû„É¢„Éº„ÉâÁî® -->
                            <div id="dropdown-controls" class="mt-3" style="display:none;">
                                <div class="row">
                                    <div class="col-md-8">
                                        <select class="form-select" id="dropdown-joint-selector">
                                            <option value="1">È†≠ÈÉ®</option>
                                            <option value="2">Âè≥ËÇ©</option>
                                            <option value="3">Âè≥ËÖ∞</option>
                                            <option value="4">Âè≥ËÜù</option>
                                            <option value="5">Â∑¶ËÜù</option>
                                            <option value="6">Âè≥Ë∂≥È¶ñ</option>
                                            <option value="7">Â∑¶Ë∂≥È¶ñ</option>
                                            <option value="8">Â∑¶ÊâãÈ¶ñ</option>
                                            <option value="9">Âè≥ÊâãÈ¶ñ</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <button class="btn btn-primary w-100" id="show-selected-joint">Ë°®Á§∫</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ÂàÜÊûê„Éú„Çø„É≥ -->
                        <div class="mt-3">
                            <div class="d-flex justify-content-between">
                                <div class="btn-group" role="group">
                                    <button class="btn btn-success" id="analyze-set-btn">
                                        üèÉ „Çª„ÉÉ„ÉàÂßøÂã¢ÂàÜÊûê
                                    </button>
                                    <button class="btn btn-info text-white" id="analyze-start-btn">
                                        üöÄ È£õ„Å≥Âá∫„ÅóÂàÜÊûê
                                    </button>
                                </div>
                                <button class="btn btn-outline-secondary" id="download-btn">
                                    <i class="bi bi-download"></i> ÁîªÂÉè‰øùÂ≠ò
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <!-- ÂàÜÊûêÁµêÊûúË°®Á§∫„Ç®„É™„Ç¢ -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">üìä ÂàÜÊûêÁµêÊûú</h5>
                    </div>
                    <div class="card-body">
                        <div class="analysis-container" id="analysis-container" style="display:none;">
                            <div class="text-center mb-3">
                                <h4>„Çπ„Ç≥„Ç¢: <span id="score" class="badge bg-success">0</span>/100</h4>
                            </div>
                            
                            <!-- ËßíÂ∫¶„Ç∞„É©„Éï -->
                            <div class="mb-4">
                                <h6>ËßíÂ∫¶ÂàÜÊûê:</h6>
                                <canvas id="angles-chart" height="200"></canvas>
                            </div>
                            
                            <!-- Ë©≥Á¥∞„Å™ËßíÂ∫¶ÊÉÖÂ†± -->
                            <div class="mb-3" id="angles-container"></div>
                            
                            <!-- „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ -->
                            <div>
                                <h6>„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ:</h6>
                                <div id="feedback-container"></div>
                            </div>
                        </div>
                        
                        <div class="text-center mt-3" id="no-analysis-message">
                            <p class="text-muted">ÁîªÂÉè„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Å¶ÂàÜÊûê„ÇíÈñãÂßã„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- „Éï„ÉÉ„Çø„Éº -->
    <footer class="mt-5">
        <div class="container">
            <p>üéØ „ÇØ„É©„Ç¶„ÉÅ„É≥„Ç∞„Çπ„Çø„É≥„ÇπÂàÜÊûê„Éó„É≠ | „Éê„Éº„Ç∏„Éß„É≥: 1.0.0</p>
            <p>üìû ÈñãÁô∫ËÄÖ: kotor-1 | „É©„Ç§„Çª„É≥„Çπ: MIT | Êõ¥Êñ∞Êó•: 2025Âπ¥8Êúà5Êó•</p>
        </div>
    </footer>

    <!-- „Éò„É´„Éó„É¢„Éº„ÉÄ„É´ -->
    <div class="modal fade" id="helpModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">‰Ωø„ÅÑÊñπ„Ç¨„Ç§„Éâ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h6>Âü∫Êú¨Êìç‰Ωú</h6>
                    <ol>
                        <li>ÁîªÂÉè„Çí„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„Åæ„Åü„ÅØÈÅ∏Êäû„Åó„Å¶„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</li>
                        <li>AIÂßøÂã¢Êé®ÂÆö„Å´„Çà„ÇäÈñ¢ÁØÄÁÇπ„ÅåËá™ÂãïÊ§úÂá∫„Åï„Çå„Åæ„Åô</li>
                        <li>4„Å§„ÅÆË™øÊï¥„É¢„Éº„Éâ„Åã„ÇâÈÅ∏„Çì„ÅßÈñ¢ÁØÄÁÇπ„ÇíË™øÊï¥„Åß„Åç„Åæ„Åô</li>
                        <li>„Äå„Çª„ÉÉ„ÉàÂßøÂã¢ÂàÜÊûê„Äç„Åæ„Åü„ÅØ„ÄåÈ£õ„Å≥Âá∫„ÅóÂàÜÊûê„Äç„ÇíÈÅ∏Êäû</li>
                        <li>ÂàÜÊûêÁµêÊûú„ÇíÁ¢∫Ë™ç„Åó„ÄÅÂøÖË¶Å„Å´Âøú„Åò„Å¶ÁîªÂÉè„Çí‰øùÂ≠ò</li>
                    </ol>
                    
                    <h6>Èñ¢ÁØÄÁÇπË™øÊï¥„É¢„Éº„Éâ</h6>
                    <ul>
                        <li><b>‚ù∂ „ÇØ„É™„ÉÉ„ÇØÈÅ∏Êäû</b>: Èñ¢ÁØÄÁÇπ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÈÅ∏Êäû„Åó„ÄÅÁîªÂÉè‰∏ä„ÅÆ‰ªªÊÑè„ÅÆÂ†¥ÊâÄ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÁßªÂãï</li>
                        <li><b>‚ù∑ ÊñπÂêë„Ç≠„ÉºË™øÊï¥</b>: „Éó„É´„ÉÄ„Ç¶„É≥„ÅßÈñ¢ÁØÄÁÇπ„ÇíÈÅ∏„Å≥„ÄÅÊñπÂêë„Éú„Çø„É≥„ÅßÁ¥∞„Åã„ÅèÁßªÂãï</li>
                        <li><b>‚ù∏ „Éó„É´„ÉÄ„Ç¶„É≥ÈÅ∏Êäû</b>: „Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„Åã„ÇâÈñ¢ÁØÄÁÇπ„ÇíÈÅ∏Êäû„Åó„Å¶Ë°®Á§∫„ÉªÁßªÂãï</li>
                        <li><b>‚ùπ ‰∏ÄÊã¨Ë°®Á§∫</b>: „Åô„Åπ„Å¶„ÅÆÈñ¢ÁØÄÁÇπ„ÇíÂêåÊôÇ„Å´Ë°®Á§∫„Åó„Å¶Ë™øÊï¥</li>
                    </ul>
                    
                    <h6>ÂàÜÊûê„É¢„Éº„Éâ</h6>
                    <ul>
                        <li><b>üèÉ „Çª„ÉÉ„ÉàÂßøÂã¢ÂàÜÊûê</b>: ÂâçË∂≥ËÜùËßíÂ∫¶„ÄÅÂæåË∂≥ËÜùËßíÂ∫¶„ÄÅËÇ°Èñ¢ÁØÄËßíÂ∫¶„ÇíÂàÜÊûê</li>
                        <li><b>üöÄ È£õ„Å≥Âá∫„ÅóÂàÜÊûê</b>: ‰∏ãÂçäË∫´ËßíÂ∫¶„ÄÅ‰∏äÂçäË∫´ËßíÂ∫¶„ÄÅ„Åè„ÅÆÂ≠óËßíÂ∫¶„ÇíÂàÜÊûê</li>
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Èñâ„Åò„Çã</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ÂÖ±Êúâ„É¢„Éº„ÉÄ„É´ -->
    <div class="modal fade" id="shareModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ÂàÜÊûêÁµêÊûú„ÇíÂÖ±Êúâ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>‰ª•‰∏ã„ÅÆURL„Çí„Ç≥„Éî„Éº„Åó„Å¶„ÉÅ„Éº„É†„É°„É≥„Éê„Éº„Å®ÂÖ±Êúâ„Åß„Åç„Åæ„Åô:</p>
                    <div class="input-group">
                        <input type="text" class="form-control" id="share-url" readonly>
                        <button class="btn btn-outline-primary" type="button" id="copy-url-btn">„Ç≥„Éî„Éº</button>
                    </div>
                    <div class="mt-2" id="copy-success" style="display:none;">
                        <div class="alert alert-success">URL„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOMË¶ÅÁ¥†„ÅÆÂèÇÁÖß„ÇíÂèñÂæó
            const imageUpload = document.getElementById('image-upload');
            const uploadDropzone = document.getElementById('upload-dropzone');
            const previewImage = document.getElementById('preview-image');
            const imageContainer = document.getElementById('image-container');
            const loadingElement = document.getElementById('loading');
            const errorMessage = document.getElementById('error-message');
            const analysisContainer = document.getElementById('analysis-container');
            const noAnalysisMessage = document.getElementById('no-analysis-message');
            const scoreElement = document.getElementById('score');
            const anglesContainer = document.getElementById('angles-container');
            const feedbackContainer = document.getElementById('feedback-container');
            const modeButtons = document.querySelectorAll('.mode-selector .btn');
            const arrowControls = document.getElementById('arrow-controls');
            const dropdownControls = document.getElementById('dropdown-controls');
            const jointSelector = document.getElementById('joint-selector');
            const downloadBtn = document.getElementById('download-btn');
            const analyzeSetBtn = document.getElementById('analyze-set-btn');
            const analyzeStartBtn = document.getElementById('analyze-start-btn');
            const shareBtn = document.getElementById('share-btn');
            const shareUrlInput = document.getElementById('share-url');
            const copyUrlBtn = document.getElementById('copy-url-btn');
            
            // Â§âÊï∞„ÅÆÂàùÊúüÂåñ
            let jointPoints = {};
            let selectedJoint = null;
            let currentMode = 'click';
            let anglesChart = null;
            
            // Èñ¢ÁØÄÁÇπ„ÅÆÂêçÂâç„Éû„ÉÉ„Éî„É≥„Ç∞
            const jointNames = {
                '1': 'È†≠ÈÉ®',
                '2': 'Âè≥ËÇ©',
                '3': 'Âè≥ËÖ∞',
                '4': 'Âè≥ËÜù',
                '5': 'Â∑¶ËÜù',
                '6': 'Âè≥Ë∂≥È¶ñ',
                '7': 'Â∑¶Ë∂≥È¶ñ',
                '8': 'Â∑¶ÊâãÈ¶ñ',
                '9': 'Âè≥ÊâãÈ¶ñ'
            };
            
            // „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„ÉóÂá¶ÁêÜ„ÅÆË®≠ÂÆö
            uploadDropzone.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('highlight');
            });
            
            uploadDropzone.addEventListener('dragleave', function() {
                this.classList.remove('highlight');
            });
            
            uploadDropzone.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('highlight');
                
                if (e.dataTransfer.files.length) {
                    handleImageUpload(e.dataTransfer.files[0]);
                }
            });
            
            // „Éï„Ç°„Ç§„É´ÈÅ∏ÊäûÂá¶ÁêÜ
            imageUpload.addEventListener('change', function(e) {
                if (e.target.files.length) {
                    handleImageUpload(e.target.files[0]);
                }
            });
            
            // ÁîªÂÉè„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂá¶ÁêÜ
            function handleImageUpload(file) {
                if (!file || !file.type.match('image.*')) {
                    showError('„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„Éï„Ç°„Ç§„É´ÂΩ¢Âºè„Åß„Åô„ÄÇÁîªÂÉè„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    return;
                }
                
                // ÁîªÂÉè„Éó„É¨„Éì„É•„Éº„ÅÆË°®Á§∫
                const reader = new FileReader();
                reader.onload = function(event) {
                    previewImage.src = event.target.result;
                    previewImage.style.display = 'block';
                    clearJointPoints();
                    detectJoints(file);
                };
                reader.readAsDataURL(file);
            }
            
            // Èñ¢ÁØÄÁÇπÊ§úÂá∫Âá¶ÁêÜ
            function detectJoints(file) {
                loadingElement.style.display = 'block';
                errorMessage.style.display = 'none';
                
                const formData = new FormData();
                formData.append('image', file);
                
                fetch('/detect_joints', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    loadingElement.style.display = 'none';
                    if (data.success) {
                        jointPoints = data.joints;
                        renderJointPoints();
                        noAnalysisMessage.style.display = 'none';
                    } else {
                        showError(data.error || 'Èñ¢ÁØÄÊ§úÂá∫„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÂà•„ÅÆÁîªÂÉè„ÇíË©¶„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    loadingElement.style.display = 'none';
                    showError('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶Ë©¶„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                });
            }
            
            // Èñ¢ÁØÄÁÇπ„ÅÆÊèèÁîª
            function renderJointPoints() {
                // Êó¢Â≠ò„ÅÆÈñ¢ÁØÄÁÇπ„Çí„ÇØ„É™„Ç¢
                clearJointPoints();
                
                // ÁîªÂÉè„ÅÆÂÆüÈöõ„ÅÆ„Çµ„Ç§„Ç∫„ÇíÂèñÂæó
                const imgWidth = previewImage.clientWidth;
                const imgHeight = previewImage.clientHeight;
                
                // Ë°®Á§∫„Åô„ÇãÈñ¢ÁØÄÁÇπ„ÇíÊ±∫ÂÆöÔºà„É¢„Éº„Éâ„Å´Âü∫„Å•„ÅèÔºâ
                let pointsToRender = {};
                
                if (currentMode === 'all') {
                    // ÂÖ®„Å¶„ÅÆÈñ¢ÁØÄÁÇπ„ÇíË°®Á§∫
                    pointsToRender = jointPoints;
                } else if (currentMode === 'dropdown' && selectedJoint) {
                    // ÈÅ∏Êäû„Åï„Çå„ÅüÈñ¢ÁØÄÁÇπ„ÅÆ„ÅøË°®Á§∫
                    pointsToRender[selectedJoint] = jointPoints[selectedJoint];
                } else if (currentMode === 'click' || currentMode === 'arrow') {
                    // ÂÖ®„Å¶„ÅÆÈñ¢ÁØÄÁÇπ„ÇíË°®Á§∫ÔºàÈÅ∏ÊäûÂèØËÉΩÁä∂ÊÖã„ÅßÔºâ
                    pointsToRender = jointPoints;
                }
                
                // Èñ¢ÁØÄÁÇπ„ÇíÊèèÁîª
                for (const key in pointsToRender) {
                    const joint = pointsToRender[key];
                    const jointElement = document.createElement('div');
                    jointElement.className = 'joint-point';
                    jointElement.id = `joint-${key}`;
                    jointElement.setAttribute('data-joint-id', key);
                    jointElement.setAttribute('title', jointNames[key] || `Èñ¢ÁØÄ ${key}`);
                    
                    // Ê≠£Ë¶èÂåñ„Åï„Çå„ÅüÂ∫ßÊ®ô„ÇíÂÆüÈöõ„ÅÆ‰ΩçÁΩÆ„Å´Â§âÊèõ
                    const x = joint.x * imgWidth;
                    const y = joint.y * imgHeight;
                    
                    jointElement.style.left = `${x}px`;
                    jointElement.style.top = `${y}px`;
                    
                    // ÈÅ∏Êäû„Åï„Çå„ÅüÈñ¢ÁØÄÁÇπ„ÇíÂº∑Ë™øË°®Á§∫
                    if (key === selectedJoint) {
                        jointElement.style.backgroundColor = 'blue';
                        jointElement.style.width = '16px';
                        jointElement.style.height = '16px';
                    }
                    
                    // „Éâ„É©„ÉÉ„Ç∞Ê©üËÉΩ„ÇíËøΩÂä†
                    makeJointDraggable(jointElement);
                    
                    // „ÇØ„É™„ÉÉ„ÇØÈÅ∏Êäû„É¢„Éº„Éâ„ÅÆÂ†¥Âêà„ÄÅ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà„ÇíËøΩÂä†
                    if (currentMode === 'click') {
                        jointElement.addEventListener('click', function(e) {
                            e.stopPropagation();
                            selectJoint(key);
                        });
                    }
                    
                    imageContainer.appendChild(jointElement);
                }
                
                // Èñ¢ÁØÄÁÇπÈñì„ÅÆÁ∑ö„Å®ËßíÂ∫¶„ÅÆÊèèÁîª
                drawLinesAndAngles();
            }
            
            // Èñ¢ÁØÄÁÇπÈñì„ÅÆÁ∑ö„Å®ËßíÂ∫¶„ÅÆÊèèÁîª
            function drawLinesAndAngles() {
                // Êó¢Â≠ò„ÅÆÁ∑ö„Å®ËßíÂ∫¶Ë°®Á§∫„Çí„ÇØ„É™„Ç¢
                document.querySelectorAll('.joint-line, .angle-text').forEach(el => el.remove());
                
                const imgWidth = previewImage.clientWidth;
                const imgHeight = previewImage.clientHeight;
                
                // Á∑ö„ÅÆÊèèÁîªÔºà‰æã: È†≠-ËÇ©-ËÖ∞-ËÜù-Ë∂≥È¶ñÔºâ
                const connections = [
                    ['1', '2'], // È†≠ ‚Üí ËÇ©
                    ['2', '3'], // ËÇ© ‚Üí ËÖ∞
                    ['3', '4'], // ËÖ∞ ‚Üí Âè≥ËÜù
                    ['3', '5'], // ËÖ∞ ‚Üí Â∑¶ËÜù
                    ['4', '6'], // Âè≥ËÜù ‚Üí Âè≥Ë∂≥È¶ñ
                    ['5', '7']  // Â∑¶ËÜù ‚Üí Â∑¶Ë∂≥È¶ñ
                ];
                
                connections.forEach(conn => {
                    if (jointPoints[conn[0]] && jointPoints[conn[1]]) {
                        const start = {
                            x: jointPoints[conn[0]].x * imgWidth,
                            y: jointPoints[conn[0]].y * imgHeight
                        };
                        const end = {
                            x: jointPoints[conn[1]].x * imgWidth,
                            y: jointPoints[conn[1]].y * imgHeight
                        };
                        
                        // Á∑ö„ÅÆÈï∑„Åï„Å®ËßíÂ∫¶„ÇíË®àÁÆó
                        const length = Math.sqrt(Math.pow(end.x - start.x, 2) + Math.pow(end.y - start.y, 2));
                        const angle = Math.atan2(end.y - start.y, end.x - start.x) * 180 / Math.PI;
                        
                        // Á∑öË¶ÅÁ¥†„ÅÆ‰ΩúÊàê
                        const line = document.createElement('div');
                        line.className = 'joint-line';
                        line.style.width = `${length}px`;
                        line.style.left = `${start.x}px`;
                        line.style.top = `${start.y}px`;
                        line.style.transform = `rotate(${angle}deg)`;
                        
                        imageContainer.appendChild(line);
                    }
                });
                
                // ËßíÂ∫¶„ÅÆË®àÁÆó„Å®Ë°®Á§∫Ôºà‰æã: ËÇ©-ËÖ∞-ËÜù„ÅÆËßíÂ∫¶Ôºâ
                const angles = [
                    { name: '‰∏äÂçäË∫´ËßíÂ∫¶', points: ['1', '2', '3'] }, // È†≠-ËÇ©-ËÖ∞
                    { name: 'Âè≥ËÜùËßíÂ∫¶', points: ['3', '4', '6'] },  // ËÖ∞-Âè≥ËÜù-Âè≥Ë∂≥È¶ñ
                    { name: 'Â∑¶ËÜùËßíÂ∫¶', points: ['3', '5', '7'] }   // ËÖ∞-Â∑¶ËÜù-Â∑¶Ë∂≥È¶ñ
                ];
                
                angles.forEach(angleData => {
                    const [p1, p2, p3] = angleData.points;
                    
                    if (jointPoints[p1] && jointPoints[p2] && jointPoints[p3]) {
                        const point1 = {
                            x: jointPoints[p1].x * imgWidth,
                            y: jointPoints[p1].y * imgHeight
                        };
                        const point2 = {
                            x: jointPoints[p2].x * imgWidth,
                            y: jointPoints[p2].y * imgHeight
                        };
                        const point3 = {
                            x: jointPoints[p3].x * imgWidth,
                            y: jointPoints[p3].y * imgHeight
                        };
                        
                        // ËßíÂ∫¶„ÅÆË®àÁÆó
                        const a = np_array([point1.x, point1.y]);
                        const b = np_array([point2.x, point2.y]);
                        const c = np_array([point3.x, point3.y]);
                        
                        const ba = array_subtract(a, b);
                        const bc = array_subtract(c, b);
                        
                        const cosine_angle = dot_product(ba, bc) / (norm(ba) * norm(bc));
                        const angle = Math.acos(Math.max(-1, Math.min(1, cosine_angle))) * 180 / Math.PI;
                        
                        // ËßíÂ∫¶Ë°®Á§∫Ë¶ÅÁ¥†„ÅÆ‰ΩúÊàê
                        const angleElement = document.createElement('div');
                        angleElement.className = 'angle-text';
                        angleElement.textContent = `${angle.toFixed(1)}¬∞`;
                        angleElement.style.left = `${point2.x}px`;
                        angleElement.style.top = `${point2.y + 15}px`;
                        
                        imageContainer.appendChild(angleElement);
                    }
                });
            }
            
            // NumPy„É©„Ç§„ÇØ„ÅÆÈñ¢Êï∞„ÇíÂÆüË£Ö
            function np_array(arr) {
                return arr;
            }
            
            function array_subtract(a, b) {
                return [a[0] - b[0], a[1] - b[1]];
            }
            
            function dot_product(a, b) {
                return a[0] * b[0] + a[1] * b[1];
            }
            
            function norm(a) {
                return Math.sqrt(a[0] * a[0] + a[1] * a[1]);
            }
            
            // Èñ¢ÁØÄÁÇπ„ÅÆ„Éâ„É©„ÉÉ„Ç∞Ê©üËÉΩ
            function makeJointDraggable(element) {
                let isDragging = false;
                let offsetX, offsetY;
                
                element.addEventListener('mousedown', startDrag);
                element.addEventListener('touchstart', startDrag, { passive: false });
                
                function startDrag(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    isDragging = true;
                    
                    // Èñ¢ÁØÄÁÇπ„ÇíÈÅ∏ÊäûÁä∂ÊÖã„Å´„Åô„Çã
                    if (currentMode === 'click' || currentMode === 'all') {
                        selectJoint(element.getAttribute('data-joint-id'));
                    }
                    
                    if (e.type === 'mousedown') {
                        offsetX = e.clientX - element.getBoundingClientRect().left;
                        offsetY = e.clientY - element.getBoundingClientRect().top;
                    } else {
                        offsetX = e.touches[0].clientX - element.getBoundingClientRect().left;
                        offsetY = e.touches[0].clientY - element.getBoundingClientRect().top;
                    }
                    
                    document.addEventListener('mousemove', dragMove);
                    document.addEventListener('touchmove', dragMove, { passive: false });
                    document.addEventListener('mouseup', stopDrag);
                    document.addEventListener('touchend', stopDrag);
                }
                
                function dragMove(e) {
                    if (!isDragging) return;
                    e.preventDefault();
                    
                    let clientX, clientY;
                    if (e.type === 'mousemove') {
                        clientX = e.clientX;
                        clientY = e.clientY;
                    } else {
                        clientX = e.touches[0].clientX;
                        clientY = e.touches[0].clientY;
                    }
                    
                    const containerRect = imageContainer.getBoundingClientRect();
                    const imgRect = previewImage.getBoundingClientRect();
                    
                    // ÁîªÂÉèÂÜÖ„Åß„ÅÆ‰ΩçÁΩÆ„ÇíË®àÁÆó
                    let x = clientX - containerRect.left - offsetX;
                    let y = clientY - containerRect.top - offsetY;
                    
                    // ÁîªÂÉè„ÅÆÁØÑÂõ≤ÂÜÖ„Å´Âà∂Èôê
                    x = Math.max(0, Math.min(x, imgRect.width));
                    y = Math.max(0, Math.min(y, imgRect.height));
                    
                    // Ë¶ÅÁ¥†„ÅÆ‰ΩçÁΩÆ„ÇíÊõ¥Êñ∞
                    element.style.left = `${x}px`;
                    element.style.top = `${y}px`;
                    
                    // Èñ¢ÁØÄÁÇπ„Éá„Éº„Çø„ÇíÊõ¥Êñ∞
                    const jointId = element.getAttribute('data-joint-id');
                    jointPoints[jointId] = {
                        x: x / imgRect.width,
                        y: y / imgRect.height
                    };
                    
                    // Á∑ö„Å®ËßíÂ∫¶„ÇíÊõ¥Êñ∞
                    drawLinesAndAngles();
                }
                
                function stopDrag() {
                    isDragging = false;
                    document.removeEventListener('mousemove', dragMove);
                    document.removeEventListener('touchmove', dragMove);
                    document.removeEventListener('mouseup', stopDrag);
                    document.removeEventListener('touchend', stopDrag);
                }
            }
            
            // Èñ¢ÁØÄÁÇπ„ÅÆÈÅ∏Êäû
            function selectJoint(jointId) {
                selectedJoint = jointId;
                
                // Èñ¢ÁØÄÁÇπ„Çª„É¨„ÇØ„Çø„ÅÆÂÄ§„ÇíÊõ¥Êñ∞
                if (jointSelector) {
                    jointSelector.value = jointId;
                }
                
                // Èñ¢ÁØÄÁÇπ„ÅÆÊèèÁîª„ÇíÊõ¥Êñ∞
                renderJointPoints();
            }
            
            // Èñ¢ÁØÄÁÇπ„ÅÆ„ÇØ„É™„Ç¢
            function clearJointPoints() {
                document.querySelectorAll('.joint-point, .joint-line, .angle-text').forEach(el => el.remove());
            }
            
            // „Ç®„É©„ÉºË°®Á§∫
            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
            }
            
            // ÂßøÂã¢ÂàÜÊûêÔºà„Çª„ÉÉ„ÉàÂßøÂã¢Ôºâ
            analyzeSetBtn.addEventListener('click', function() {
                analyzePosture('set');
            });
            
            // ÂßøÂã¢ÂàÜÊûêÔºàÈ£õ„Å≥Âá∫„ÅóÔºâ
            analyzeStartBtn.addEventListener('click', function() {
                analyzePosture('start');
            });
            
            // ÂßøÂã¢ÂàÜÊûê„ÅÆÂÆüË°å
            function analyzePosture(mode) {
                if (Object.keys(jointPoints).length === 0) {
                    showError('Èñ¢ÁØÄÁÇπ„ÅåÊ§úÂá∫„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇÁîªÂÉè„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    return;
                }
                
                loadingElement.style.display = 'block';
                errorMessage.style.display = 'none';
                
                fetch('/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        joints: jointPoints,
                        mode: mode
                    })
                })
                .then(response => response.json())
                .then(data => {
                    loadingElement.style.display = 'none';
                    if (data.success) {
                        displayAnalysisResults(data.analysis, mode);
                    } else {
                        showError(data.error || 'ÂàÜÊûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶Ë©¶„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    loadingElement.style.display = 'none';
                    showError('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶Ë©¶„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                });
            }
            
            // ÂàÜÊûêÁµêÊûú„ÅÆË°®Á§∫
            function displayAnalysisResults(analysis, mode) {
                // „Çπ„Ç≥„Ç¢„ÇíË°®Á§∫
                scoreElement.textContent = analysis.score;
                
                // ËßíÂ∫¶ÊÉÖÂ†±„ÇíË°®Á§∫
                anglesContainer.innerHTML = '';
                for (const [key, value] of Object.entries(analysis.angles)) {
                    const angleElement = document.createElement('div');
                    angleElement.className = 'mb-2';
                    
                    // ËßíÂ∫¶Âêç„ÅÆ„Éû„ÉÉ„Éî„É≥„Ç∞
                    let angleName = key;
                    if (mode === 'set') {
                        if (key === 'back_angle') angleName = '‰∏äÂçäË∫´ËßíÂ∫¶';
                        else if (key === 'knee_angle') angleName = 'ÂâçË∂≥ËÜùËßíÂ∫¶';
                        else if (key === 'ankle_angle') angleName = 'ÂæåË∂≥ËÜùËßíÂ∫¶';
                    } else {
                        if (key === 'back_angle') angleName = '‰∏äÂçäË∫´ËßíÂ∫¶';
                        else if (key === 'knee_angle') angleName = '‰∏ãÂçäË∫´ËßíÂ∫¶';
                        else if (key === 'ankle_angle') angleName = '„Åè„ÅÆÂ≠óËßíÂ∫¶';
                    }
                    
                    angleElement.innerHTML = `<strong>${angleName}:</strong> ${value}¬∞`;
                    anglesContainer.appendChild(angleElement);
                }
                
                // „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÇíË°®Á§∫
                feedbackContainer.innerHTML = '';
                analysis.feedback.forEach(feedback => {
                    const feedbackElement = document.createElement('div');
                    feedbackElement.className = 'feedback-item mb-2';
                    feedbackElement.textContent = feedback;
                    feedbackContainer.appendChild(feedbackElement);
                });
                
                // „Ç∞„É©„Éï„ÅÆÊõ¥Êñ∞
                updateAnglesChart(analysis.angles, mode);
                
                // ÂàÜÊûêÁµêÊûú„ÇíË°®Á§∫
                analysisContainer.style.display = 'block';
                noAnalysisMessage.style.display = 'none';
            }
            
            // ËßíÂ∫¶„Ç∞„É©„Éï„ÅÆÊõ¥Êñ∞
            function updateAnglesChart(angles, mode) {
                const ctx = document.getElementById('angles-chart').getContext('2d');
                
                // „Ç∞„É©„Éï„ÅÆ„É©„Éô„É´„Å®„Éá„Éº„Çø„ÇíË®≠ÂÆö
                let labels = [];
                let data = [];
                let idealValues = [];
                
                if (mode === 'set') {
                    labels = ['‰∏äÂçäË∫´ËßíÂ∫¶', 'ÂâçË∂≥ËÜùËßíÂ∫¶', 'ÂæåË∂≥ËÜùËßíÂ∫¶'];
                    data = [
                        angles.back_angle || 0,
                        angles.knee_angle || 0,
                        angles.ankle_angle || 0
                    ];
                    idealValues = [45, 90, 85]; // ÁêÜÊÉ≥ÁöÑ„Å™ÂÄ§
                } else {
                    labels = ['‰∏äÂçäË∫´ËßíÂ∫¶', '‰∏ãÂçäË∫´ËßíÂ∫¶', '„Åè„ÅÆÂ≠óËßíÂ∫¶'];
                    data = [
                        angles.back_angle || 0,
                        angles.knee_angle || 0,
                        angles.ankle_angle || 0
                    ];
                    idealValues = [40, 110, 150]; // ÁêÜÊÉ≥ÁöÑ„Å™ÂÄ§
                }
                
                // Êó¢Â≠ò„ÅÆ„Ç∞„É©„Éï„ÇíÁ†¥Ê£Ñ
                if (anglesChart) {
                    anglesChart.destroy();
                }
                
                // Êñ∞„Åó„ÅÑ„Ç∞„É©„Éï„Çí‰ΩúÊàê
                anglesChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'ÁèæÂú®„ÅÆËßíÂ∫¶',
                                data: data,
                                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'ÁêÜÊÉ≥ÁöÑ„Å™ËßíÂ∫¶',
                                data: idealValues,
                                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 1,
                                type: 'line'
                            }
                        ]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 180
                            }
                        },
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
            
            // „É¢„Éº„ÉâÂàáÊõø„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„ÉàË®≠ÂÆö
            modeButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„ÇØ„É©„Çπ„ÇíÂàá„ÇäÊõø„Åà
                    modeButtons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // „É¢„Éº„Éâ„ÇíÂàá„ÇäÊõø„Åà
                    currentMode = this.getAttribute('data-mode');
                    
                    // „Ç≥„É≥„Éà„É≠„Éº„É´„Éë„Éç„É´„ÅÆË°®Á§∫ÂàáÊõø
                    arrowControls.style.display = currentMode === 'arrow' ? 'block' : 'none';
                    dropdownControls.style.display = currentMode === 'dropdown' ? 'block' : 'none';
                    
                    // Èñ¢ÁØÄÁÇπ„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞
                    renderJointPoints();
                });
            });
            
            // ÊñπÂêë„Ç≠„Éº„Ç≥„É≥„Éà„É≠„Éº„É´„ÅÆ„Ç§„Éô„É≥„ÉàË®≠ÂÆö
            document.querySelectorAll('.arrow-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (!selectedJoint || !jointPoints[selectedJoint]) return;
                    
                    const dir = this.getAttribute('data-dir');
                    const imgWidth = previewImage.clientWidth;
                    const imgHeight = previewImage.clientHeight;
                    const step = 0.005; // ÁßªÂãï„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó„Çµ„Ç§„Ç∫
                    
                    let dx = 0, dy = 0;
                    
                    // ÊñπÂêë„Å´Âü∫„Å•„ÅÑ„Å¶ÁßªÂãïÈáè„ÇíË®≠ÂÆö
                    switch (dir) {
                        case 'n': dy = -step; break;
                        case 's': dy = step; break;
                        case 'e': dx = step; break;
                        case 'w': dx = -step; break;
                        case 'ne': dx = step; dy = -step; break;
                        case 'nw': dx = -step; dy = -step; break;
                        case 'se': dx = step; dy = step; break;
                        case 'sw': dx = -step; dy = step; break;
                        case 'c': break; // ‰∏≠Â§Æ„Éú„Çø„É≥„ÅØÁßªÂãï„Å™„Åó
                    }
                    
                    // Èñ¢ÁØÄÁÇπ„ÅÆ‰ΩçÁΩÆ„ÇíÊõ¥Êñ∞
                    jointPoints[selectedJoint].x = Math.max(0, Math.min(1, jointPoints[selectedJoint].x + dx));
                    jointPoints[selectedJoint].y = Math.max(0, Math.min(1, jointPoints[selectedJoint].y + dy));
                    
                    // Èñ¢ÁØÄÁÇπ„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞
                    renderJointPoints();
                });
            });
            
            // „Ç∏„Éß„Ç§„É≥„Éà„Çª„É¨„ÇØ„Çø„ÅÆÂ§âÊõ¥„Ç§„Éô„É≥„Éà
            if (jointSelector) {
                jointSelector.addEventListener('change', function() {
                    selectJoint(this.value);
                });
            }
            
            // „Éó„É´„ÉÄ„Ç¶„É≥ÈÅ∏Êäû„É¢„Éº„Éâ„ÅÆ„Ç∏„Éß„Ç§„É≥„ÉàË°®Á§∫„Éú„Çø„É≥
            document.getElementById('show-selected-joint').addEventListener('click', function() {
                const selectedValue = document.getElementById('dropdown-joint-selector').value;
                selectJoint(selectedValue);
            });
            
            // ÁîªÂÉè„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñ¢ÁØÄÁÇπ„ÇíÈÖçÁΩÆÔºà„ÇØ„É™„ÉÉ„ÇØ„É¢„Éº„ÉâÔºâ
            imageContainer.addEventListener('click', function(e) {
                if (currentMode !== 'click' || !selectedJoint) return;
                
                const rect = imageContainer.getBoundingClientRect();
                const imgRect = previewImage.getBoundingClientRect();
                
                // „ÇØ„É™„ÉÉ„ÇØ‰ΩçÁΩÆ„ÇíË®àÁÆó
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // ÁîªÂÉèÂÜÖ„ÅÆÁõ∏ÂØæ‰ΩçÁΩÆ„Å´Â§âÊèõ
                const relX = x / imgRect.width;
                const relY = y / imgRect.height;
                
                // Èñ¢ÁØÄÁÇπ„Éá„Éº„Çø„ÇíÊõ¥Êñ∞
                jointPoints[selectedJoint] = { x: relX, y: relY };
                
                // Èñ¢ÁØÄÁÇπ„ÇíÂÜçÊèèÁîª
                renderJointPoints();
            });
            
            // ÁîªÂÉè„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Éú„Çø„É≥
            downloadBtn.addEventListener('click', function() {
                if (!previewImage.src) {
                    showError('„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åô„ÇãÁîªÂÉè„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ');
                    return;
                }
                
                // CanvasË¶ÅÁ¥†„Çí‰ΩúÊàê„Åó„ÄÅÁîªÂÉè„Å®Èñ¢ÁØÄÁÇπ„ÉªÁ∑ö„ÇíÊèèÁîª
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // ÁîªÂÉè„ÅÆ„Çµ„Ç§„Ç∫„Å´Âêà„Çè„Åõ„Çã
                canvas.width = previewImage.naturalWidth;
                canvas.height = previewImage.naturalHeight;
                
                // ÁîªÂÉè„ÇíÊèèÁîª
                const img = new Image();
                img.onload = function() {
                    ctx.drawImage(img, 0, 0);
                    
                    // Èñ¢ÁØÄÁÇπ„Å®Á∑ö„ÇíÊèèÁîªÔºà„Çπ„Ç±„Éº„É´„ÇíË™øÊï¥Ôºâ
                    const scaleX = img.naturalWidth / previewImage.clientWidth;
                    const scaleY = img.naturalHeight / previewImage.clientHeight;
                    
                    // Á∑ö„ÇíÊèèÁîª
                    document.querySelectorAll('.joint-line').forEach(line => {
                        const left = parseFloat(line.style.left) * scaleX;
                        const top = parseFloat(line.style.top) * scaleY;
                        const width = parseFloat(line.style.width) * scaleX;
                        const transform = line.style.transform;
                        const angle = parseFloat(transform.replace('rotate(', '').replace('deg)', ''));
                        
                        ctx.save();
                        ctx.translate(left, top);
                        ctx.rotate(angle * Math.PI / 180);
                        ctx.fillStyle = 'yellow';
                        ctx.fillRect(0, -1 * scaleY, width, 2 * scaleY);
                        ctx.restore();
                    });
                    
                    // Èñ¢ÁØÄÁÇπ„ÇíÊèèÁîª
                    document.querySelectorAll('.joint-point').forEach(point => {
                        const left = parseFloat(point.style.left) * scaleX;
                        const top = parseFloat(point.style.top) * scaleY;
                        const radius = 6 * scaleX;
                        
                        ctx.beginPath();
                        ctx.arc(left, top, radius, 0, 2 * Math.PI);
                        ctx.fillStyle = 'red';
                        ctx.fill();
                        ctx.strokeStyle = 'white';
                        ctx.lineWidth = 2;
                        ctx.stroke();
                    });
                    
                    // ËßíÂ∫¶„ÉÜ„Ç≠„Çπ„Éà„ÇíÊèèÁîª
                    document.querySelectorAll('.angle-text').forEach(text => {
                        const left = parseFloat(text.style.left) * scaleX;
                        const top = parseFloat(text.style.top) * scaleY;
                        
                        ctx.font = `${12 * scaleX}px Arial`;
                        ctx.fillStyle = 'white';
                        ctx.strokeStyle = 'black';
                        ctx.lineWidth = 3;
                        ctx.strokeText(text.textContent, left, top);
                        ctx.fillText(text.textContent, left, top);
                    });
                    
                
