<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸƒ ã‚¯ãƒ©ã‚¦ãƒãƒ³ã‚°ã‚¹ã‚¿ãƒ³ã‚¹åˆ†æãƒ—ãƒ­</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .dropzone {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s;
        }
        .dropzone.highlight {
            border-color: #007bff;
            background-color: rgba(0,123,255,0.1);
        }
        .joint-point {
            position: absolute;
            width: 12px;
            height: 12px;
            background-color: red;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: move;
            z-index: 10;
            border: 2px solid white;
        }
        .joint-line {
            position: absolute;
            background-color: yellow;
            height: 2px;
            transform-origin: left center;
            z-index: 5;
        }
        .angle-text {
            position: absolute;
            color: white;
            background-color: rgba(0,0,0,0.6);
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 12px;
            z-index: 15;
        }
        .image-container {
            position: relative;
            margin: 15px 0;
            max-width: 100%;
            overflow: hidden;
        }
        #preview-image {
            max-width: 100%;
            display: none;
        }
        .mode-selector .btn {
            margin-right: 5px;
            margin-bottom: 5px;
        }
        .analysis-container {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        .feedback-item {
            margin: 5px 0;
            padding: 8px;
            border-radius: 4px;
            background-color: #e9ecef;
        }
        footer {
            margin-top: 40px;
            padding: 20px 0;
            background-color: #f8f9fa;
            text-align: center;
        }
        .joint-control-panel {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        .joint-number {
            position: absolute;
            color: white;
            background-color: rgba(0,0,0,0.6);
            width: 18px;
            height: 18px;
            border-radius: 50%;
            font-size: 10px;
            text-align: center;
            line-height: 18px;
            transform: translate(-50%, -50%);
            z-index: 11;
            margin-left: 6px;
            margin-top: -6px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">ğŸƒ ã‚¯ãƒ©ã‚¦ãƒãƒ³ã‚°ã‚¹ã‚¿ãƒ³ã‚¹åˆ†æãƒ—ãƒ­</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#helpModal">
                            <i class="bi bi-question-circle"></i> ä½¿ã„æ–¹
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-lg-8">
                <!-- ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">ğŸ–¼ï¸ ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h5>
                    </div>
                    <div class="card-body">
                        <div class="dropzone" id="upload-dropzone">
                            <p class="mb-2">ç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</p>
                            <p>ã¾ãŸã¯</p>
                            <input type="file" id="image-upload" class="d-none" accept="image/*">
                            <button class="btn btn-primary" onclick="document.getElementById('image-upload').click()">
                                <i class="bi bi-upload"></i> ç”»åƒã‚’é¸æŠ
                            </button>
                        </div>
                        <div class="mt-2 text-center" id="loading" style="display:none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p>ğŸ¤– AIåˆ†æä¸­...</p>
                        </div>
                        <div class="alert alert-danger mt-3" id="error-message" style="display:none;"></div>
                    </div>
                </div>

                <!-- ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨é–¢ç¯€ç‚¹ç·¨é›†ã‚¨ãƒªã‚¢ -->
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">ğŸ“ å§¿å‹¢åˆ†æ</h5>
                    </div>
                    <div class="card-body">
                        <div class="image-container" id="image-container">
                            <img id="preview-image" alt="ã‚¯ãƒ©ã‚¦ãƒãƒ³ã‚°å§¿å‹¢">
                            <!-- é–¢ç¯€ç‚¹ã¨ãƒ©ã‚¤ãƒ³ã¯JSã§å‹•çš„ã«è¿½åŠ  -->
                        </div>

                        <!-- é–¢ç¯€ç‚¹ç·¨é›†ãƒ¢ãƒ¼ãƒ‰é¸æŠ -->
                        <div class="joint-control-panel mt-3">
                            <h6>ğŸ”¢ é–¢ç¯€ç‚¹èª¿æ•´ãƒ¢ãƒ¼ãƒ‰:</h6>
                            <div class="mode-selector btn-group" role="group">
                                <button type="button" class="btn btn-outline-primary active" data-mode="dropdown">
                                    â¶ ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³é¸æŠ
                                </button>
                                <button type="button" class="btn btn-outline-primary" data-mode="horizontal">
                                    â· æ¨ªä¸¦ã³è¡¨ç¤º
                                </button>
                            </div>

                            <!-- ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³é¸æŠãƒ¢ãƒ¼ãƒ‰ç”¨ -->
                            <div id="dropdown-controls" class="mt-3">
                                <div class="row">
                                    <div class="col-md-8">
                                        <select class="form-select" id="dropdown-joint-selector">
                                            <option value="1">â‘  é¼»/é ­éƒ¨</option>
                                            <option value="2">â‘¡ å³è‚©</option>
                                            <option value="3">â‘¢ å³è…°</option>
                                            <option value="4">â‘£ å³è†</option>
                                            <option value="5">â‘¤ å·¦è†</option>
                                            <option value="6">â‘¥ å³è¶³é¦–</option>
                                            <option value="7">â‘¦ å·¦è¶³é¦–</option>
                                            <option value="8">â‘§ å·¦æ‰‹é¦–</option>
                                            <option value="9">â‘¨ å³æ‰‹é¦–</option>
                                            <option value="10">â‘© ç¬¬7é ¸æ¤(C7)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <button class="btn btn-primary w-100" id="show-selected-joint">è¡¨ç¤º/èª¿æ•´</button>
                                    </div>
                                </div>
                                <div class="row mt-3" id="joint-adjustment-panel" style="display:none;">
                                    <div class="col-md-6">
                                        <label for="joint-x-input">Xåº§æ¨™ï¼ˆå·¦å³ï¼‰:</label>
                                        <input type="range" class="form-range" id="joint-x-input" min="0" max="100" value="50">
                                        <div class="text-center" id="joint-x-value">50%</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="joint-y-input">Yåº§æ¨™ï¼ˆä¸Šä¸‹ï¼‰:</label>
                                        <input type="range" class="form-range" id="joint-y-input" min="0" max="100" value="50">
                                        <div class="text-center" id="joint-y-value">50%</div>
                                    </div>
                                </div>
                            </div>

                            <!-- æ¨ªä¸¦ã³è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ç”¨ -->
                            <div id="horizontal-controls" class="mt-3" style="display:none;">
                                <div class="row" id="upper-body-controls">
                                    <h6>ä¸ŠåŠèº«é–¢ç¯€ç‚¹:</h6>
                                    <div class="col mb-3" id="joint-1-control">
                                        <small>â‘  é¼»/é ­éƒ¨</small>
                                        <button class="btn btn-sm btn-outline-secondary w-100 mb-1 joint-adjust-btn" data-joint="1">èª¿æ•´</button>
                                    </div>
                                    <div class="col mb-3" id="joint-2-control">
                                        <small>â‘¡ å³è‚©</small>
                                        <button class="btn btn-sm btn-outline-secondary w-100 mb-1 joint-adjust-btn" data-joint="2">èª¿æ•´</button>
                                    </div>
                                    <div class="col mb-3" id="joint-3-control">
                                        <small>â‘¢ å³è…°</small>
                                        <button class="btn btn-sm btn-outline-secondary w-100 mb-1 joint-adjust-btn" data-joint="3">èª¿æ•´</button>
                                    </div>
                                    <div class="col mb-3" id="joint-10-control">
                                        <small>â‘© C7</small>
                                        <button class="btn btn-sm btn-outline-secondary w-100 mb-1 joint-adjust-btn" data-joint="10">èª¿æ•´</button>
                                    </div>
                                </div>
                                <div class="row" id="lower-body-controls">
                                    <h6>ä¸‹åŠèº«é–¢ç¯€ç‚¹:</h6>
                                    <div class="col mb-3" id="joint-4-control">
                                        <small>â‘£ å³è†</small>
                                        <button class="btn btn-sm btn-outline-secondary w-100 mb-1 joint-adjust-btn" data-joint="4">èª¿æ•´</button>
                                    </div>
                                    <div class="col mb-3" id="joint-5-control">
                                        <small>â‘¤ å·¦è†</small>
                                        <button class="btn btn-sm btn-outline-secondary w-100 mb-1 joint-adjust-btn" data-joint="5">èª¿æ•´</button>
                                    </div>
                                    <div class="col mb-3" id="joint-6-control">
                                        <small>â‘¥ å³è¶³é¦–</small>
                                        <button class="btn btn-sm btn-outline-secondary w-100 mb-1 joint-adjust-btn" data-joint="6">èª¿æ•´</button>
                                    </div>
                                    <div class="col mb-3" id="joint-7-control">
                                        <small>â‘¦ å·¦è¶³é¦–</small>
                                        <button class="btn btn-sm btn-outline-secondary w-100 mb-1 joint-adjust-btn" data-joint="7">èª¿æ•´</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- åˆ†æãƒœã‚¿ãƒ³ -->
                        <div class="mt-3">
                            <div class="d-flex justify-content-between">
                                <div class="btn-group" role="group">
                                    <button class="btn btn-success" id="analyze-set-btn">
                                        ğŸƒ ã‚»ãƒƒãƒˆå§¿å‹¢åˆ†æ
                                    </button>
                                    <button class="btn btn-info text-white" id="analyze-start-btn">
                                        ğŸš€ é£›ã³å‡ºã—åˆ†æ
                                    </button>
                                </div>
                                <button class="btn btn-outline-secondary" id="download-btn">
                                    <i class="bi bi-download"></i> ç”»åƒä¿å­˜
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <!-- åˆ†æçµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">ğŸ“Š åˆ†æçµæœ</h5>
                    </div>
                    <div class="card-body">
                        <div class="analysis-container" id="analysis-container" style="display:none;">
                            <div class="text-center mb-3">
                                <h4>ã‚¹ã‚³ã‚¢: <span id="score" class="badge bg-success">0</span>/100</h4>
                            </div>
                            
                            <!-- è§’åº¦ã‚°ãƒ©ãƒ• -->
                            <div class="mb-4">
                                <h6>è§’åº¦åˆ†æ:</h6>
                                <canvas id="angles-chart" height="200"></canvas>
                            </div>
                            
                            <!-- è©³ç´°ãªè§’åº¦æƒ…å ± -->
                            <div class="mb-3" id="angles-container"></div>
                            
                            <!-- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ -->
                            <div>
                                <h6>ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯:</h6>
                                <div id="feedback-container"></div>
                            </div>
                        </div>
                        
                        <div class="text-center mt-3" id="no-analysis-message">
                            <p class="text-muted">ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦åˆ†æã‚’é–‹å§‹ã—ã¦ãã ã•ã„</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
    <footer class="mt-5">
        <div class="container">
            <p>ğŸ¯ ã‚¯ãƒ©ã‚¦ãƒãƒ³ã‚°ã‚¹ã‚¿ãƒ³ã‚¹åˆ†æãƒ—ãƒ­ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 1.0.0</p>
            <p>ğŸ“ é–‹ç™ºè€…: kotor-1 | ãƒ©ã‚¤ã‚»ãƒ³ã‚¹: MIT | æ›´æ–°æ—¥: 2025å¹´8æœˆ5æ—¥</p>
        </div>
    </footer>

    <!-- ãƒ˜ãƒ«ãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="helpModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h6>åŸºæœ¬æ“ä½œ</h6>
                    <ol>
                        <li>ç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã¾ãŸã¯é¸æŠã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</li>
                        <li>AIå§¿å‹¢æ¨å®šã«ã‚ˆã‚Šé–¢ç¯€ç‚¹ãŒè‡ªå‹•æ¤œå‡ºã•ã‚Œã¾ã™</li>
                        <li>é–¢ç¯€ç‚¹ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä½ç½®ã‚’èª¿æ•´ã§ãã¾ã™</li>
                        <li>ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚„æ¨ªä¸¦ã³è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã§è©³ç´°èª¿æ•´ã‚‚å¯èƒ½</li>
                        <li>ã€Œã‚»ãƒƒãƒˆå§¿å‹¢åˆ†æã€ã¾ãŸã¯ã€Œé£›ã³å‡ºã—åˆ†æã€ã‚’é¸æŠ</li>
                        <li>åˆ†æçµæœã‚’ç¢ºèªã—ã€å¿…è¦ã«å¿œã˜ã¦ç”»åƒã‚’ä¿å­˜</li>
                    </ol>
                    
                    <h6>é–¢ç¯€ç‚¹èª¿æ•´ãƒ¢ãƒ¼ãƒ‰</h6>
                    <ul>
                        <li><b>â¶ ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³é¸æŠ</b>: ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‹ã‚‰é–¢ç¯€ç‚¹ã‚’é¸ã³ã€ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§ä½ç½®ã‚’èª¿æ•´</li>
                        <li><b>â· æ¨ªä¸¦ã³è¡¨ç¤º</b>: ã™ã¹ã¦ã®é–¢ç¯€ç‚¹ã®ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã—ã€ã‚¯ãƒªãƒƒã‚¯ã—ã¦å€‹åˆ¥ã«èª¿æ•´</li>
                    </ul>
                    
                    <h6>åˆ†æãƒ¢ãƒ¼ãƒ‰</h6>
                    <ul>
                        <li><b>ğŸƒ ã‚»ãƒƒãƒˆå§¿å‹¢åˆ†æ</b>: å‰è¶³è†è§’åº¦ã€å¾Œè¶³è†è§’åº¦ã€è‚¡é–¢ç¯€è§’åº¦ã‚’åˆ†æ</li>
                        <li><b>ğŸš€ é£›ã³å‡ºã—åˆ†æ</b>: ä¸‹åŠèº«è§’åº¦ã€ä¸ŠåŠèº«è§’åº¦ã€ãã®å­—è§’åº¦ã‚’åˆ†æ</li>
                    </ul>
                    
                    <h6>é–¢ç¯€ç‚¹èª¬æ˜</h6>
                    <p>â‘  é¼»/é ­éƒ¨ â‘¡ å³è‚© â‘¢ å³è…° â‘£ å³è† â‘¤ å·¦è† â‘¥ å³è¶³é¦– â‘¦ å·¦è¶³é¦– â‘§ å·¦æ‰‹é¦– â‘¨ å³æ‰‹é¦– â‘© ç¬¬7é ¸æ¤(C7)</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOMè¦ç´ ã®å‚ç…§ã‚’å–å¾—
            const imageUpload = document.getElementById('image-upload');
            const uploadDropzone = document.getElementById('upload-dropzone');
            const previewImage = document.getElementById('preview-image');
            const imageContainer = document.getElementById('image-container');
            const loadingElement = document.getElementById('loading');
            const errorMessage = document.getElementById('error-message');
            const analysisContainer = document.getElementById('analysis-container');
            const noAnalysisMessage = document.getElementById('no-analysis-message');
            const scoreElement = document.getElementById('score');
            const anglesContainer = document.getElementById('angles-container');
            const feedbackContainer = document.getElementById('feedback-container');
            const modeButtons = document.querySelectorAll('.mode-selector .btn');
            const dropdownControls = document.getElementById('dropdown-controls');
            const horizontalControls = document.getElementById('horizontal-controls');
            const dropdownJointSelector = document.getElementById('dropdown-joint-selector');
            const showSelectedJointBtn = document.getElementById('show-selected-joint');
            const jointAdjustmentPanel = document.getElementById('joint-adjustment-panel');
            const jointXInput = document.getElementById('joint-x-input');
            const jointYInput = document.getElementById('joint-y-input');
            const jointXValue = document.getElementById('joint-x-value');
            const jointYValue = document.getElementById('joint-y-value');
            const jointAdjustBtns = document.querySelectorAll('.joint-adjust-btn');
            const downloadBtn = document.getElementById('download-btn');
            const analyzeSetBtn = document.getElementById('analyze-set-btn');
            const analyzeStartBtn = document.getElementById('analyze-start-btn');
            
            // å¤‰æ•°ã®åˆæœŸåŒ–
            let jointPoints = {};
            let selectedJoint = null;
            let currentMode = 'dropdown';
            let anglesChart = null;
            let isDragging = false;
            let dragTarget = null;
            let dragOffsetX = 0;
            let dragOffsetY = 0;
            
            // é–¢ç¯€ç‚¹ã®åå‰ãƒãƒƒãƒ”ãƒ³ã‚°
            const jointNames = {
                '1': 'â‘  é¼»/é ­éƒ¨',
                '2': 'â‘¡ å³è‚©',
                '3': 'â‘¢ å³è…°',
                '4': 'â‘£ å³è†',
                '5': 'â‘¤ å·¦è†',
                '6': 'â‘¥ å³è¶³é¦–',
                '7': 'â‘¦ å·¦è¶³é¦–',
                '8': 'â‘§ å·¦æ‰‹é¦–',
                '9': 'â‘¨ å³æ‰‹é¦–',
                '10': 'â‘© C7'
            };
            
            // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†ã®è¨­å®š
            uploadDropzone.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('highlight');
            });
            
            uploadDropzone.addEventListener('dragleave', function() {
                this.classList.remove('highlight');
            });
            
            uploadDropzone.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('highlight');
                
                if (e.dataTransfer.files.length) {
                    handleImageUpload(e.dataTransfer.files[0]);
                }
            });
            
            // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå‡¦ç†
            imageUpload.addEventListener('change', function(e) {
                if (e.target.files.length) {
                    handleImageUpload(e.target.files[0]);
                }
            });
            
            // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
            function handleImageUpload(file) {
                if (!file || !file.type.match('image.*')) {
                    showError('ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ã€‚ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                
                // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®è¡¨ç¤º
                const reader = new FileReader();
                reader.onload = function(event) {
                    previewImage.src = event.target.result;
                    previewImage.style.display = 'block';
                    clearJointPoints();
                    detectJoints(file);
                };
                reader.readAsDataURL(file);
            }
            
            // é–¢ç¯€ç‚¹æ¤œå‡ºå‡¦ç†
            function detectJoints(file) {
                loadingElement.style.display = 'block';
                errorMessage.style.display = 'none';
                
                const formData = new FormData();
                formData.append('image', file);
                
                fetch('/detect_joints', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    loadingElement.style.display = 'none';
                    if (data.success) {
                        jointPoints = data.joints;
                        renderJointPoints();
                        noAnalysisMessage.style.display = 'none';
                    } else {
                        showError(data.error || 'é–¢ç¯€æ¤œå‡ºã«å¤±æ•—ã—ã¾ã—ãŸã€‚åˆ¥ã®ç”»åƒã‚’è©¦ã—ã¦ãã ã•ã„ã€‚');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    loadingElement.style.display = 'none';
                    showError('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ãã ã•ã„ã€‚');
                });
            }
            
            // é–¢ç¯€ç‚¹ã®æç”»
            function renderJointPoints() {
                // æ—¢å­˜ã®é–¢ç¯€ç‚¹ã‚’ã‚¯ãƒªã‚¢
                clearJointPoints();
                
                // ç”»åƒã®å®Ÿéš›ã®ã‚µã‚¤ã‚ºã‚’å–å¾—
                const imgWidth = previewImage.clientWidth;
                const imgHeight = previewImage.clientHeight;
                
                // é–¢ç¯€ç‚¹ã®æç”»
                for (const key in jointPoints) {
                    const joint = jointPoints[key];
                    const jointElement = document.createElement('div');
                    jointElement.className = 'joint-point';
                    jointElement.id = `joint-${key}`;
                    jointElement.setAttribute('data-joint-id', key);
                    jointElement.setAttribute('title', jointNames[key] || `é–¢ç¯€ ${key}`);
                    
                    // æ­£è¦åŒ–ã•ã‚ŒãŸåº§æ¨™ã‚’å®Ÿéš›ã®ä½ç½®ã«å¤‰æ›
                    const x = joint.x * imgWidth;
                    const y = joint.y * imgHeight;
                    
                    jointElement.style.left = `${x}px`;
                    jointElement.style.top = `${y}px`;
                    
                    // é¸æŠã•ã‚ŒãŸé–¢ç¯€ç‚¹ã‚’å¼·èª¿è¡¨ç¤º
                    if (key === selectedJoint) {
                        jointElement.style.backgroundColor = 'blue';
                        jointElement.style.width = '16px';
                        jointElement.style.height = '16px';
                    }
                    
                    // é–¢ç¯€ç•ªå·ã®è¡¨ç¤º
                    const jointNumber = document.createElement('div');
                    jointNumber.className = 'joint-number';
                    jointNumber.textContent = key;
                    jointElement.appendChild(jointNumber);
                    
                    // ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½ã‚’è¿½åŠ 
                    addDragListeners(jointElement);
                    
                    imageContainer.appendChild(jointElement);
                }
                
                // é–¢ç¯€ç‚¹é–“ã®ç·šã‚’æç”»
                drawLines();
            }
            
            // ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½ã®è¿½åŠ 
            function addDragListeners(element) {
                element.addEventListener('mousedown', startDrag);
                element.addEventListener('touchstart', startDrag, { passive: false });
                
                function startDrag(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    isDragging = true;
                    dragTarget = element;
                    
                    const jointId = element.getAttribute('data-joint-id');
                    selectJoint(jointId);
                    
                    if (e.type === 'mousedown') {
                        dragOffsetX = e.clientX - element.getBoundingClientRect().left;
                        dragOffsetY = e.clientY - element.getBoundingClientRect().top;
                    } else {
                        dragOffsetX = e.touches[0].clientX - element.getBoundingClientRect().left;
                        dragOffsetY = e.touches[0].clientY - element.getBoundingClientRect().top;
                    }
                    
                    // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ã‚¤ãƒ™ãƒ³ãƒˆ
                    document.addEventListener('mousemove', dragMove);
                    document.addEventListener('touchmove', dragMove, { passive: false });
                    
                    // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
                    document.addEventListener('mouseup', stopDrag);
                    document.addEventListener('touchend', stopDrag);
                }
            }
            
            // ãƒ‰ãƒ©ãƒƒã‚°ç§»å‹•å‡¦ç†
            function dragMove(e) {
                if (!isDragging || !dragTarget) return;
                e.preventDefault();
                
                let clientX, clientY;
                if (e.type === 'mousemove') {
                    clientX = e.clientX;
                    clientY = e.clientY;
                } else {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                }
                
                const containerRect = imageContainer.getBoundingClientRect();
                const imgRect = previewImage.getBoundingClientRect();
                
                // ç”»åƒå†…ã§ã®ä½ç½®ã‚’è¨ˆç®—
                let x = clientX - containerRect.left - dragOffsetX;
                let y = clientY - containerRect.top - dragOffsetY;
                
                // ç”»åƒã®ç¯„å›²å†…ã«åˆ¶é™
                x = Math.max(0, Math.min(x, imgRect.width));
                y = Math.max(0, Math.min(y, imgRect.height));
                
                // è¦ç´ ã®ä½ç½®ã‚’æ›´æ–°
                dragTarget.style.left = `${x}px`;
                dragTarget.style.top = `${y}px`;
                
                // é–¢ç¯€ç‚¹ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
                const jointId = dragTarget.getAttribute('data-joint-id');
                jointPoints[jointId].x = x / imgRect.width;
                jointPoints[jointId].y = y / imgRect.height;
                
                // UIã®æ›´æ–°
                updateJointControlUI(jointId);
                
                // ç·šã®æ›´æ–°
                drawLines();
            }
            
            // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†å‡¦ç†
            function stopDrag() {
                isDragging = false;
                dragTarget = null;
                
                document.removeEventListener('mousemove', dragMove);
                document.removeEventListener('touchmove', dragMove);
                document.removeEventListener('mouseup', stopDrag);
                document.removeEventListener('touchend', stopDrag);
            }
            
            // é–¢ç¯€ç‚¹é–“ã®ç·šã‚’æç”»
            function drawLines() {
                // æ—¢å­˜ã®ç·šã‚’ã‚¯ãƒªã‚¢
                document.querySelectorAll('.joint-line').forEach(el => el.remove());
                
                const imgWidth = previewImage.clientWidth;
                const imgHeight = previewImage.clientHeight;
                
                // é–¢ç¯€ç‚¹ã®æ¥ç¶šã‚’å®šç¾©
                const connections = [
                    ['1', '2'], // é¼» â†’ å³è‚©
                    ['2', '3'], // å³è‚© â†’ å³è…°
                    ['3', '4'], // å³è…° â†’ å³è†
                    ['4', '6'], // å³è† â†’ å³è¶³é¦–
                    ['3', '5'], // å³è…° â†’ å·¦è†
                    ['5', '7'], // å·¦è† â†’ å·¦è¶³é¦–
                    ['2', '10'], // å³è‚© â†’ C7
                ];
                
                // C7ã‹ã‚‰è…°ã¸ã®æ¥ç¶šï¼ˆé£›ã³å‡ºã—åˆ†æç”¨ï¼‰
                if (jointPoints['10'] && jointPoints['3']) {
                    connections.push(['10', '3']); // C7 â†’ å³è…°
                }
                
                // ç·šã‚’æç”»
                connections.forEach(conn => {
                    if (jointPoints[conn[0]] && jointPoints[conn[1]]) {
                        const start = {
                            x: jointPoints[conn[0]].x * imgWidth,
                            y: jointPoints[conn[0]].y * imgHeight
                        };
                        const end = {
                            x: jointPoints[conn[1]].x * imgWidth,
                            y: jointPoints[conn[1]].y * imgHeight
                        };
                        
                        // ç·šã®é•·ã•ã¨è§’åº¦ã‚’è¨ˆç®—
                        const length = Math.sqrt(Math.pow(end.x - start.x, 2) + Math.pow(end.y - start.y, 2));
                        const angle = Math.atan2(end.y - start.y, end.x - start.x) * 180 / Math.PI;
                        
                        // ç·šè¦ç´ ã®ä½œæˆ
                        const line = document.createElement('div');
                        line.className = 'joint-line';
                        line.style.width = `${length}px`;
                        line.style.left = `${start.x}px`;
                        line.style.top = `${start.y}px`;
                        line.style.transform = `rotate(${angle}deg)`;
                        
                        // C7ã‹ã‚‰è…°ã¸ã®ç·šã¯ç‰¹åˆ¥ãªè‰²
                        if (conn[0] === '10' && conn[1] === '3') {
                            line.style.backgroundColor = 'purple';
                            line.style.height = '4px';
                        }
                        
                        imageContainer.appendChild(line);
                    }
                });
            }
            
            // é–¢ç¯€ç‚¹ã®é¸æŠ
            function selectJoint(jointId) {
                selectedJoint = jointId;
                
                // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®å€¤ã‚’æ›´æ–°
                if (dropdownJointSelector) {
                    dropdownJointSelector.value = jointId;
                }
                
                // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å€¤ã‚’æ›´æ–°
                updateJointControlUI(jointId);
                
                // é–¢ç¯€ç‚¹ã®æç”»ã‚’æ›´æ–°
                renderJointPoints();
            }
            
            // é–¢ç¯€ç‚¹ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«UIã‚’æ›´æ–°
            function updateJointControlUI(jointId) {
                if (!jointPoints[jointId]) return;
                
                const joint = jointPoints[jointId];
                
                // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å€¤ã‚’æ›´æ–°
                jointXInput.value = Math.round(joint.x * 100);
                jointYInput.value = Math.round(joint.y * 100);
                jointXValue.textContent = `${Math.round(joint.x * 100)}%`;
                jointYValue.textContent = `${Math.round(joint.y * 100)}%`;
                
                // èª¿æ•´ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º
                jointAdjustmentPanel.style.display = 'flex';
            }
            
            // é–¢ç¯€ç‚¹ã®ã‚¯ãƒªã‚¢
            function clearJointPoints() {
                document.querySelectorAll('.joint-point, .joint-line').forEach(el => el.remove());
            }
            
            // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
            }
            
            // å§¿å‹¢åˆ†æï¼ˆã‚»ãƒƒãƒˆå§¿å‹¢ï¼‰
            analyzeSetBtn.addEventListener('click', function() {
                analyzePosture('set');
            });
            
            // å§¿å‹¢åˆ†æï¼ˆé£›ã³å‡ºã—ï¼‰
            analyzeStartBtn.addEventListener('click', function() {
                analyzePosture('start');
            });
            
            // å§¿å‹¢åˆ†æã®å®Ÿè¡Œ
            function analyzePosture(mode) {
                if (Object.keys(jointPoints).length === 0) {
                    showError('é–¢ç¯€ç‚¹ãŒæ¤œå‡ºã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                
                loadingElement.style.display = 'block';
                errorMessage.style.display = 'none';
                
                fetch('/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        joints: jointPoints,
                        mode: mode
                    })
                })
                .then(response => response.json())
                .then(data => {
                    loadingElement.style.display = 'none';
                    if (data.success) {
                        displayAnalysisResults(data.analysis, mode);
                    } else {
                        showError(data.error || 'åˆ†æã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ãã ã•ã„ã€‚');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    loadingElement.style.display = 'none';
                    showError('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ãã ã•ã„ã€‚');
                });
            }
            
            // åˆ†æçµæœã®è¡¨ç¤º
            function displayAnalysisResults(analysis, mode) {
                // ã‚¹ã‚³ã‚¢ã‚’è¡¨ç¤º
                scoreElement.textContent = analysis.score;
                
                // è§’åº¦æƒ…å ±ã‚’è¡¨ç¤º
                anglesContainer.innerHTML = '';
                
                if (mode === 'set') {
                    const angles = {
                        'å‰è¶³è†è§’åº¦': analysis.angles.front_angle,
                        'å¾Œè¶³è†è§’åº¦': analysis.angles.rear_angle,
                        'å‰è¶³è‚¡é–¢ç¯€è§’åº¦': analysis.angles.hip_angle
                    };
                    
                    for (const [key, value] of Object.entries(angles)) {
                        const angleElement = document.createElement('div');
                        angleElement.className = 'mb-2';
                        angleElement.innerHTML = `<strong>${key}:</strong> ${value}Â°`;
                        anglesContainer.appendChild(angleElement);
                    }
                    
                    // ã‚°ãƒ©ãƒ•ã®æ›´æ–°
                    updateAnglesChart(
                        ['å‰è¶³è†è§’åº¦', 'å¾Œè¶³è†è§’åº¦', 'å‰è¶³è‚¡é–¢ç¯€è§’åº¦'],
                        [analysis.angles.front_angle, analysis.angles.rear_angle, analysis.angles.hip_angle],
                        [90, 125, 50]
                    );
                } else {
                    const angles = {
                        'ä¸‹åŠèº«è§’åº¦': analysis.angles.lower_angle,
                        'ä¸ŠåŠèº«è§’åº¦': analysis.angles.upper_angle,
                        'ãã®å­—è§’åº¦': analysis.angles.kunoji_angle
                    };
                    
                    for (const [key, value] of Object.entries(angles)) {
                        const angleElement = document.createElement('div');
                        angleElement.className = 'mb-2';
                        angleElement.innerHTML = `<strong>${key}:</strong> ${value}Â°`;
                        anglesContainer.appendChild(angleElement);
                    }
                    
                    // ã‚°ãƒ©ãƒ•ã®æ›´æ–°
                    updateAnglesChart(
                        ['ä¸‹åŠèº«è§’åº¦', 'ä¸ŠåŠèº«è§’åº¦', 'ãã®å­—è§’åº¦'],
                        [analysis.angles.lower_angle, analysis.angles.upper_angle, analysis.angles.kunoji_angle],
                        [45, 40, 160]
                    );
                }
                
                // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è¡¨ç¤º
                feedbackContainer.innerHTML = '';
                analysis.feedback.forEach(feedback => {
                    const feedbackElement = document.createElement('div');
                    feedbackElement.className = 'feedback-item mb-2';
                    feedbackElement.textContent = feedback;
                    
                    // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã«å¿œã˜ã¦è‰²ã‚’å¤‰æ›´
                    if (feedback.includes('ç†æƒ³çš„')) {
                        feedbackElement.style.backgroundColor = '#d1e7dd';
                    } else if (feedback.includes('è¿‘ã¥ã‘') || feedback.includes('æ„è­˜')) {
                        feedbackElement.style.backgroundColor = '#f8d7da';
                    }
                    
                    feedbackContainer.appendChild(feedbackElement);
                });
                
                // åˆ†æçµæœã‚’è¡¨ç¤º
                analysisContainer.style.display = 'block';
                noAnalysisMessage.style.display = 'none';
            }
            
            // è§’åº¦ã‚°ãƒ©ãƒ•ã®æ›´æ–°
            function updateAnglesChart(labels, values, idealValues) {
                const ctx = document.getElementById('angles-chart').getContext('2d');
                
                // æ—¢å­˜ã®ã‚°ãƒ©ãƒ•ã‚’ç ´æ£„
                if (anglesChart) {
                    anglesChart.destroy();
                }
                
                // æ–°ã—ã„ã‚°ãƒ©ãƒ•ã‚’ä½œæˆ
                anglesChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'æ¸¬å®šå€¤',
                                data: values,
                                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'ç†æƒ³å€¤',
                                data: idealValues,
                                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 1,
                                type: 'line'
                            }
                        ]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: Math.max(...values, ...idealValues) * 1.2
                            }
                        },
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
            
            // ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
            modeButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¯ãƒ©ã‚¹ã‚’åˆ‡ã‚Šæ›¿ãˆ
                    modeButtons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // ãƒ¢ãƒ¼ãƒ‰ã‚’åˆ‡ã‚Šæ›¿ãˆ
                    currentMode = this.getAttribute('data-mode');
                    
                    // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ«ã®è¡¨ç¤ºåˆ‡æ›¿
                    dropdownControls.style.display = currentMode === 'dropdown' ? 'block' : 'none';
                    horizontalControls.style.display = currentMode === 'horizontal' ? 'block' : 'none';
                });
            });
            
            // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³é¸æŠã—ãŸé–¢ç¯€ç‚¹ã®è¡¨ç¤ºãƒœã‚¿ãƒ³
            showSelectedJointBtn.addEventListener('click', function() {
                const jointId = dropdownJointSelector.value;
                selectJoint(jointId);
            });
            
            // Xåº§æ¨™ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆ
            jointXInput.addEventListener('input', function() {
                if (!selectedJoint || !jointPoints[selectedJoint]) return;
                
                const value = parseInt(this.value) / 100;
                jointXValue.textContent = `${this.value}%`;
                
                jointPoints[selectedJoint].x = value;
                renderJointPoints();
            });
            
            // Yåº§æ¨™ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆ
            jointYInput.addEventListener('input', function() {
                if (!selectedJoint || !jointPoints[selectedJoint]) return;
                
                const value = parseInt(this.value) / 100;
                jointYValue.textContent = `${this.value}%`;
                
                jointPoints[selectedJoint].y = value;
                renderJointPoints();
            });
            
            // æ¨ªä¸¦ã³è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã®é–¢ç¯€ç‚¹èª¿æ•´ãƒœã‚¿ãƒ³
            jointAdj
