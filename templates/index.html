<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>クラウチスタンス分析ツール</title>
    <style>
        body { font-family: Arial; margin: 0 auto; max-width: 800px; padding: 20px; }
        h1 { text-align: center; }
        .container { display: flex; flex-direction: column; align-items: center; }
        .image-container { margin: 20px 0; position: relative; }
        #preview-image { max-width: 100%; display: none; }
        .joint-point { 
            position: absolute; width: 10px; height: 10px; 
            background: red; border-radius: 50%; 
            transform: translate(-50%, -50%);
        }
        .analysis-container { 
            display: none; margin: 20px 0; padding: 15px;
            background: #f5f5f5; border-radius: 5px;
        }
        button { 
            background: #4CAF50; color: white; 
            border: none; padding: 10px 15px; 
            border-radius: 4px; cursor: pointer; 
        }
        button:disabled { background: #ccc; }
    </style>
</head>
<body>
    <h1>クラウチスタンス分析ツール</h1>
    
    <div class="container">
        <div>
            <input type="file" id="image-upload" accept="image/*">
            <button id="analyze-btn" disabled>姿勢を分析</button>
        </div>
        
        <div id="loading" style="display:none;">分析中...</div>
        <div id="error-message" style="color:red;"></div>
        
        <div class="image-container" id="image-container">
            <img id="preview-image" alt="プレビュー">
        </div>
        
        <div class="analysis-container" id="analysis-container">
            <div>スコア: <span id="score">0</span>/100</div>
            <div id="angles-container"></div>
            <div id="feedback-container"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const imageUpload = document.getElementById('image-upload');
            const previewImage = document.getElementById('preview-image');
            const imageContainer = document.getElementById('image-container');
            const analyzeBtn = document.getElementById('analyze-btn');
            const loadingElement = document.getElementById('loading');
            const errorMessage = document.getElementById('error-message');
            const analysisContainer = document.getElementById('analysis-container');
            const scoreElement = document.getElementById('score');
            const anglesContainer = document.getElementById('angles-container');
            const feedbackContainer = document.getElementById('feedback-container');
            
            let jointPoints = {};
            
            imageUpload.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    previewImage.src = event.target.result;
                    previewImage.style.display = 'block';
                    
                    // 関節点検出
                    detectJoints(file);
                };
                reader.readAsDataURL(file);
            });
            
            function detectJoints(file) {
                loadingElement.style.display = 'block';
                errorMessage.textContent = '';
                
                const formData = new FormData();
                formData.append('image', file);
                
                fetch('/detect_joints', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    loadingElement.style.display = 'none';
                    if (data.success) {
                        jointPoints = data.joints;
                        renderJointPoints();
                        analyzeBtn.disabled = false;
                    } else {
                        errorMessage.textContent = data.error || '関節検出に失敗しました';
                    }
                })
                .catch(error => {
                    loadingElement.style.display = 'none';
                    errorMessage.textContent = 'エラーが発生しました: ' + error;
                    console.error(error);
                });
            }
            
            function renderJointPoints() {
                // 既存の関節点をクリア
                document.querySelectorAll('.joint-point').forEach(el => el.remove());
                
                const imgWidth = previewImage.clientWidth;
                const imgHeight = previewImage.clientHeight;
                
                for (const key in jointPoints) {
                    const joint = jointPoints[key];
                    const element = document.createElement('div');
                    element.className = 'joint-point';
                    element.style.left = (joint.x * imgWidth) + 'px';
                    element.style.top = (joint.y * imgHeight) + 'px';
                    
                    imageContainer.appendChild(element);
                }
            }
            
            analyzeBtn.addEventListener('click', function() {
                loadingElement.style.display = 'block';
                errorMessage.textContent = '';
                
                fetch('/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ joints: jointPoints })
                })
                .then(response => response.json())
                .then(data => {
                    loadingElement.style.display = 'none';
                    if (data.success) {
                        displayResults(data.analysis);
                    } else {
                        errorMessage.textContent = data.error || '分析に失敗しました';
                    }
                })
                .catch(error => {
                    loadingElement.style.display = 'none';
                    errorMessage.textContent = 'エラーが発生しました: ' + error;
                    console.error(error);
                });
            });
            
            function displayResults(analysis) {
                scoreElement.textContent = analysis.score;
                
                anglesContainer.innerHTML = '';
                for (const [key, value] of Object.entries(analysis.angles)) {
                    const angleElement = document.createElement('div');
                    let angleName = key;
                    if (key === 'back_angle') angleName = '背中の角度';
                    else if (key === 'knee_angle') angleName = '膝の角度';
                    else if (key === 'ankle_angle') angleName = '足首の角度';
                    
                    angleElement.textContent = `${angleName}: ${value}°`;
                    anglesContainer.appendChild(angleElement);
                }
                
                feedbackContainer.innerHTML = '';
                analysis.feedback.forEach(feedback => {
                    const element = document.createElement('div');
                    element.style.margin = '5px 0';
                    element.style.padding = '5px';
                    element.style.background = '#e9e9e9';
                    element.textContent = feedback;
                    feedbackContainer.appendChild(element);
                });
                
                analysisContainer.style.display = 'block';
            }
        });
    </script>
</body>
</html>
