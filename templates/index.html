<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèÉ „ÇØ„É©„Ç¶„ÉÅ„É≥„Ç∞„Çπ„Çø„É≥„ÇπÂàÜÊûê„Éó„É≠</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .dropzone {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s;
        }
        .dropzone.highlight {
            border-color: #007bff;
            background-color: rgba(0,123,255,0.1);
        }
        .joint-point {
            position: absolute;
            width: 12px;
            height: 12px;
            background-color: red;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: move;
            z-index: 10;
            border: 2px solid white;
        }
        .joint-line {
            position: absolute;
            background-color: yellow;
            height: 2px;
            transform-origin: left center;
            z-index: 5;
        }
        .angle-text {
            position: absolute;
            color: white;
            background-color: rgba(0,0,0,0.6);
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 12px;
            z-index: 15;
        }
        .image-container {
            position: relative;
            margin: 15px 0;
            max-width: 100%;
            overflow: hidden;
        }
        #preview-image {
            max-width: 100%;
            display: none;
        }
        .mode-selector .btn {
            margin-right: 5px;
            margin-bottom: 5px;
        }
        .analysis-container {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        .feedback-item {
            margin: 5px 0;
            padding: 8px;
            border-radius: 4px;
            background-color: #e9ecef;
        }
        footer {
            margin-top: 40px;
            padding: 20px 0;
            background-color: #f8f9fa;
            text-align: center;
        }
        .joint-control-panel {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        .joint-number {
            position: absolute;
            color: white;
            background-color: rgba(0,0,0,0.6);
            width: 18px;
            height: 18px;
            border-radius: 50%;
            font-size: 10px;
            text-align: center;
            line-height: 18px;
            transform: translate(-50%, -50%);
            z-index: 11;
            margin-left: 6px;
            margin-top: -6px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">üèÉ „ÇØ„É©„Ç¶„ÉÅ„É≥„Ç∞„Çπ„Çø„É≥„ÇπÂàÜÊûê„Éó„É≠</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#helpModal">
                            <i class="bi bi-question-circle"></i> ‰Ωø„ÅÑÊñπ
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-lg-8">
                <!-- ÁîªÂÉè„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Ç®„É™„Ç¢ -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">üñºÔ∏è ÁîªÂÉè„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</h5>
                    </div>
                    <div class="card-body">
                        <div class="dropzone" id="upload-dropzone">
                            <p class="mb-2">ÁîªÂÉè„Çí„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó</p>
                            <p>„Åæ„Åü„ÅØ</p>
                            <input type="file" id="image-upload" class="d-none" accept="image/*">
                            <button class="btn btn-primary" onclick="document.getElementById('image-upload').click()">
                                <i class="bi bi-upload"></i> ÁîªÂÉè„ÇíÈÅ∏Êäû
                            </button>
                        </div>
                        <div class="mt-2 text-center" id="loading" style="display:none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p>ü§ñ AIÂàÜÊûê‰∏≠...</p>
                        </div>
                        <div class="alert alert-danger mt-3" id="error-message" style="display:none;"></div>
                    </div>
                </div>

                <!-- ÁîªÂÉè„Éó„É¨„Éì„É•„Éº„Å®Èñ¢ÁØÄÁÇπÁ∑®ÈõÜ„Ç®„É™„Ç¢ -->
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">üìê ÂßøÂã¢ÂàÜÊûê</h5>
                    </div>
                    <div class="card-body">
                        <div class="image-container" id="image-container">
                            <img id="preview-image" alt="„ÇØ„É©„Ç¶„ÉÅ„É≥„Ç∞ÂßøÂã¢">
                            <!-- Èñ¢ÁØÄÁÇπ„Å®„É©„Ç§„É≥„ÅØJS„ÅßÂãïÁöÑ„Å´ËøΩÂä† -->
                        </div>

                        <!-- Èñ¢ÁØÄÁÇπÁ∑®ÈõÜ„É¢„Éº„ÉâÈÅ∏Êäû -->
                        <div class="joint-control-panel mt-3">
                            <h6>üî¢ Èñ¢ÁØÄÁÇπË™øÊï¥„É¢„Éº„Éâ:</h6>
                            <div class="mode-selector btn-group" role="group">
                                <button type="button" class="btn btn-outline-primary active" data-mode="dropdown">
                                    ‚ù∂ „Éó„É´„ÉÄ„Ç¶„É≥ÈÅ∏Êäû
                                </button>
                                <button type="button" class="btn btn-outline-primary" data-mode="horizontal">
                                    ‚ù∑ Ê®™‰∏¶„Å≥Ë°®Á§∫
                                </button>
                            </div>

                            <!-- „Éó„É´„ÉÄ„Ç¶„É≥ÈÅ∏Êäû„É¢„Éº„ÉâÁî® -->
                            <div id="dropdown-controls" class="mt-3">
                                <div class="row">
                                    <div class="col-md-8">
                                        <select class="form-select" id="dropdown-joint-selector">
                                            <option value="1">‚ë† Èºª/È†≠ÈÉ®</option>
                                            <option value="2">‚ë° Âè≥ËÇ©</option>
                                            <option value="3">‚ë¢ Âè≥ËÖ∞</option>
                                            <option value="4">‚ë£ Âè≥ËÜù</option>
                                            <option value="5">‚ë§ Â∑¶ËÜù</option>
                                            <option value="6">‚ë• Âè≥Ë∂≥È¶ñ</option>
                                            <option value="7">‚ë¶ Â∑¶Ë∂≥È¶ñ</option>
                                            <option value="8">‚ëß Â∑¶ÊâãÈ¶ñ</option>
                                            <option value="9">‚ë® Âè≥ÊâãÈ¶ñ</option>
                                            <option value="10">‚ë© Á¨¨7È†∏Ê§é(C7)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <button class="btn btn-primary w-100" id="show-selected-joint">Ë°®Á§∫/Ë™øÊï¥</button>
                                    </div>
                                </div>
                                <div class="row mt-3" id="joint-adjustment-panel" style="display:none;">
                                    <div class="col-md-6">
                                        <label for="joint-x-input">XÂ∫ßÊ®ôÔºàÂ∑¶Âè≥Ôºâ:</label>
                                        <input type="range" class="form-range" id="joint-x-input" min="0" max="100" value="50">
                                        <div class="text-center" id="joint-x-value">50%</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="joint-y-input">YÂ∫ßÊ®ôÔºà‰∏ä‰∏ãÔºâ:</label>
                                        <input type="range" class="form-range" id="joint-y-input" min="0" max="100" value="50">
                                        <div class="text-center" id="joint-y-value">50%</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Ê®™‰∏¶„Å≥Ë°®Á§∫„É¢„Éº„ÉâÁî® -->
                            <div id="horizontal-controls" class="mt-3" style="display:none;">
                                <div class="row" id="upper-body-controls">
                                    <h6>‰∏äÂçäË∫´Èñ¢ÁØÄÁÇπ:</h6>
                                    <div class="col mb-3" id="joint-1-control">
                                        <small>‚ë† Èºª/È†≠ÈÉ®</small>
                                        <button class="btn btn-sm btn-outline-secondary w-100 mb-1 joint-adjust-btn" data-joint="1">Ë™øÊï¥</button>
                                    </div>
                                    <div class="col mb-3" id="joint-2-control">
                                        <small>‚ë° Âè≥ËÇ©</small>
                                        <button class="btn btn-sm btn-outline-secondary w-100 mb-1 joint-adjust-btn" data-joint="2">Ë™øÊï¥</button>
                                    </div>
                                    <div class="col mb-3" id="joint-3-control">
                                        <small>‚ë¢ Âè≥ËÖ∞</small>
                                        <button class="btn btn-sm btn-outline-secondary w-100 mb-1 joint-adjust-btn" data-joint="3">Ë™øÊï¥</button>
                                    </div>
                                    <div class="col mb-3" id="joint-10-control">
                                        <small>‚ë© C7</small>
                                        <button class="btn btn-sm btn-outline-secondary w-100 mb-1 joint-adjust-btn" data-joint="10">Ë™øÊï¥</button>
                                    </div>
                                </div>
                                <div class="row" id="lower-body-controls">
                                    <h6>‰∏ãÂçäË∫´Èñ¢ÁØÄÁÇπ:</h6>
                                    <div class="col mb-3" id="joint-4-control">
                                        <small>‚ë£ Âè≥ËÜù</small>
                                        <button class="btn btn-sm btn-outline-secondary w-100 mb-1 joint-adjust-btn" data-joint="4">Ë™øÊï¥</button>
                                    </div>
                                    <div class="col mb-3" id="joint-5-control">
                                        <small>‚ë§ Â∑¶ËÜù</small>
                                        <button class="btn btn-sm btn-outline-secondary w-100 mb-1 joint-adjust-btn" data-joint="5">Ë™øÊï¥</button>
                                    </div>
                                    <div class="col mb-3" id="joint-6-control">
                                        <small>‚ë• Âè≥Ë∂≥È¶ñ</small>
                                        <button class="btn btn-sm btn-outline-secondary w-100 mb-1 joint-adjust-btn" data-joint="6">Ë™øÊï¥</button>
                                    </div>
                                    <div class="col mb-3" id="joint-7-control">
                                        <small>‚ë¶ Â∑¶Ë∂≥È¶ñ</small>
                                        <button class="btn btn-sm btn-outline-secondary w-100 mb-1 joint-adjust-btn" data-joint="7">Ë™øÊï¥</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ÂàÜÊûê„Éú„Çø„É≥ -->
                        <div class="mt-3">
                            <div class="d-flex justify-content-between">
                                <div class="btn-group" role="group">
                                    <button class="btn btn-success" id="analyze-set-btn">
                                        üèÉ „Çª„ÉÉ„ÉàÂßøÂã¢ÂàÜÊûê
                                    </button>
                                    <button class="btn btn-info text-white" id="analyze-start-btn">
                                        üöÄ È£õ„Å≥Âá∫„ÅóÂàÜÊûê
                                    </button>
                                </div>
                                <button class="btn btn-outline-secondary" id="download-btn">
                                    <i class="bi bi-download"></i> ÁîªÂÉè‰øùÂ≠ò
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <!-- ÂàÜÊûêÁµêÊûúË°®Á§∫„Ç®„É™„Ç¢ -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">üìä ÂàÜÊûêÁµêÊûú</h5>
                    </div>
                    <div class="card-body">
                        <div class="analysis-container" id="analysis-container" style="display:none;">
                            <div class="text-center mb-3">
                                <h4>„Çπ„Ç≥„Ç¢: <span id="score" class="badge bg-success">0</span>/100</h4>
                            </div>
                            
                            <!-- ËßíÂ∫¶„Ç∞„É©„Éï -->
                            <div class="mb-4">
                                <h6>ËßíÂ∫¶ÂàÜÊûê:</h6>
                                <canvas id="angles-chart" height="200"></canvas>
                            </div>
                            
                            <!-- Ë©≥Á¥∞„Å™ËßíÂ∫¶ÊÉÖÂ†± -->
                            <div class="mb-3" id="angles-container"></div>
                            
                            <!-- „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ -->
                            <div>
                                <h6>„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ:</h6>
                                <div id="feedback-container"></div>
                            </div>
                        </div>
                        
                        <div class="text-center mt-3" id="no-analysis-message">
                            <p class="text-muted">ÁîªÂÉè„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Å¶ÂàÜÊûê„ÇíÈñãÂßã„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- „Éï„ÉÉ„Çø„Éº -->
    <footer class="mt-5">
        <div class="container">
            <p>üéØ „ÇØ„É©„Ç¶„ÉÅ„É≥„Ç∞„Çπ„Çø„É≥„ÇπÂàÜÊûê„Éó„É≠ | „Éê„Éº„Ç∏„Éß„É≥: 1.0.0</p>
            <p>üìû ÈñãÁô∫ËÄÖ: kotor-1 | „É©„Ç§„Çª„É≥„Çπ: MIT | Êõ¥Êñ∞Êó•: 2025Âπ¥8Êúà5Êó•</p>
        </div>
    </footer>

    <!-- „Éò„É´„Éó„É¢„Éº„ÉÄ„É´ -->
    <div class="modal fade" id="helpModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">‰Ωø„ÅÑÊñπ„Ç¨„Ç§„Éâ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h6>Âü∫Êú¨Êìç‰Ωú</h6>
                    <ol>
                        <li>ÁîªÂÉè„Çí„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„Åæ„Åü„ÅØÈÅ∏Êäû„Åó„Å¶„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</li>
                        <li>AIÂßøÂã¢Êé®ÂÆö„Å´„Çà„ÇäÈñ¢ÁØÄÁÇπ„ÅåËá™ÂãïÊ§úÂá∫„Åï„Çå„Åæ„Åô</li>
                        <li>Èñ¢ÁØÄÁÇπ„Çí„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶‰ΩçÁΩÆ„ÇíË™øÊï¥„Åß„Åç„Åæ„Åô</li>
                        <li>„Éó„É´„ÉÄ„Ç¶„É≥„ÇÑÊ®™‰∏¶„Å≥Ë°®Á§∫„É¢„Éº„Éâ„ÅßË©≥Á¥∞Ë™øÊï¥„ÇÇÂèØËÉΩ</li>
                        <li>„Äå„Çª„ÉÉ„ÉàÂßøÂã¢ÂàÜÊûê„Äç„Åæ„Åü„ÅØ„ÄåÈ£õ„Å≥Âá∫„ÅóÂàÜÊûê„Äç„ÇíÈÅ∏Êäû</li>
                        <li>ÂàÜÊûêÁµêÊûú„ÇíÁ¢∫Ë™ç„Åó„ÄÅÂøÖË¶Å„Å´Âøú„Åò„Å¶ÁîªÂÉè„Çí‰øùÂ≠ò</li>
                    </ol>
                    
                    <h6>Èñ¢ÁØÄÁÇπË™øÊï¥„É¢„Éº„Éâ</h6>
                    <ul>
                        <li><b>‚ù∂ „Éó„É´„ÉÄ„Ç¶„É≥ÈÅ∏Êäû</b>: „Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„Åã„ÇâÈñ¢ÁØÄÁÇπ„ÇíÈÅ∏„Å≥„ÄÅ„Çπ„É©„Ç§„ÉÄ„Éº„Åß‰ΩçÁΩÆ„ÇíË™øÊï¥</li>
                        <li><b>‚ù∑ Ê®™‰∏¶„Å≥Ë°®Á§∫</b>: „Åô„Åπ„Å¶„ÅÆÈñ¢ÁØÄÁÇπ„ÅÆ„Éú„Çø„É≥„ÇíË°®Á§∫„Åó„ÄÅ„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÂÄãÂà•„Å´Ë™øÊï¥</li>
                    </ul>
                    
                    <h6>ÂàÜÊûê„É¢„Éº„Éâ</h6>
                    <ul>
                        <li><b>üèÉ „Çª„ÉÉ„ÉàÂßøÂã¢ÂàÜÊûê</b>: ÂâçË∂≥ËÜùËßíÂ∫¶„ÄÅÂæåË∂≥ËÜùËßíÂ∫¶„ÄÅËÇ°Èñ¢ÁØÄËßíÂ∫¶„ÇíÂàÜÊûê</li>
                        <li><b>üöÄ È£õ„Å≥Âá∫„ÅóÂàÜÊûê</b>: ‰∏ãÂçäË∫´ËßíÂ∫¶„ÄÅ‰∏äÂçäË∫´ËßíÂ∫¶„ÄÅ„Åè„ÅÆÂ≠óËßíÂ∫¶„ÇíÂàÜÊûê</li>
                    </ul>
                    
                    <h6>Èñ¢ÁØÄÁÇπË™¨Êòé</h6>
                    <p>‚ë† Èºª/È†≠ÈÉ® ‚ë° Âè≥ËÇ© ‚ë¢ Âè≥ËÖ∞ ‚ë£ Âè≥ËÜù ‚ë§ Â∑¶ËÜù ‚ë• Âè≥Ë∂≥È¶ñ ‚ë¶ Â∑¶Ë∂≥È¶ñ ‚ëß Â∑¶ÊâãÈ¶ñ ‚ë® Âè≥ÊâãÈ¶ñ ‚ë© Á¨¨7È†∏Ê§é(C7)</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Èñâ„Åò„Çã</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOMË¶ÅÁ¥†„ÅÆÂèÇÁÖß„ÇíÂèñÂæó
            const imageUpload = document.getElementById('image-upload');
            const uploadDropzone = document.getElementById('upload-dropzone');
            const previewImage = document.getElementById('preview-image');
            const imageContainer = document.getElementById('image-container');
            const loadingElement = document.getElementById('loading');
            const errorMessage = document.getElementById('error-message');
            const analysisContainer = document.getElementById('analysis-container');
            const noAnalysisMessage = document.getElementById('no-analysis-message');
            const scoreElement = document.getElementById('score');
            const anglesContainer = document.getElementById('angles-container');
            const feedbackContainer = document.getElementById('feedback-container');
            const modeButtons = document.querySelectorAll('.mode-selector .btn');
            const dropdownControls = document.getElementById('dropdown-controls');
            const horizontalControls = document.getElementById('horizontal-controls');
            const dropdownJointSelector = document.getElementById('dropdown-joint-selector');
            const showSelectedJointBtn = document.getElementById('show-selected-joint');
            const jointAdjustmentPanel = document.getElementById('joint-adjustment-panel');
            const jointXInput = document.getElementById('joint-x-input');
            const jointYInput = document.getElementById('joint-y-input');
            const jointXValue = document.getElementById('joint-x-value');
            const jointYValue = document.getElementById('joint-y-value');
            const jointAdjustBtns = document.querySelectorAll('.joint-adjust-btn');
            const downloadBtn = document.getElementById('download-btn');
            const analyzeSetBtn = document.getElementById('analyze-set-btn');
            const analyzeStartBtn = document.getElementById('analyze-start-btn');
            
            // Â§âÊï∞„ÅÆÂàùÊúüÂåñ
            let jointPoints = {};
            let selectedJoint = null;
            let currentMode = 'dropdown';
            let anglesChart = null;
            let isDragging = false;
            let dragTarget = null;
            let dragOffsetX = 0;
            let dragOffsetY = 0;
            
            // Èñ¢ÁØÄÁÇπ„ÅÆÂêçÂâç„Éû„ÉÉ„Éî„É≥„Ç∞
            const jointNames = {
                '1': '‚ë† Èºª/È†≠ÈÉ®',
                '2': '‚ë° Âè≥ËÇ©',
                '3': '‚ë¢ Âè≥ËÖ∞',
                '4': '‚ë£ Âè≥ËÜù',
                '5': '‚ë§ Â∑¶ËÜù',
                '6': '‚ë• Âè≥Ë∂≥È¶ñ',
                '7': '‚ë¶ Â∑¶Ë∂≥È¶ñ',
                '8': '‚ëß Â∑¶ÊâãÈ¶ñ',
                '9': '‚ë® Âè≥ÊâãÈ¶ñ',
                '10': '‚ë© C7'
            };
            
            // „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„ÉóÂá¶ÁêÜ„ÅÆË®≠ÂÆö
            uploadDropzone.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('highlight');
            });
            
            uploadDropzone.addEventListener('dragleave', function() {
                this.classList.remove('highlight');
            });
            
            uploadDropzone.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('highlight');
                
                if (e.dataTransfer.files.length) {
                    handleImageUpload(e.dataTransfer.files[0]);
                }
            });
            
            // „Éï„Ç°„Ç§„É´ÈÅ∏ÊäûÂá¶ÁêÜ
            imageUpload.addEventListener('change', function(e) {
                if (e.target.files.length) {
                    handleImageUpload(e.target.files[0]);
                }
            });
            
            // ÁîªÂÉè„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂá¶ÁêÜ
            function handleImageUpload(file) {
                if (!file || !file.type.match('image.*')) {
                    showError('„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„Éï„Ç°„Ç§„É´ÂΩ¢Âºè„Åß„Åô„ÄÇÁîªÂÉè„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    return;
                }
                
                // ÁîªÂÉè„Éó„É¨„Éì„É•„Éº„ÅÆË°®Á§∫
                const reader = new FileReader();
                reader.onload = function(event) {
                    previewImage.src = event.target.result;
                    previewImage.style.display = 'block';
                    clearJointPoints();
                    detectJoints(file);
                };
                reader.readAsDataURL(file);
            }
            
            // Èñ¢ÁØÄÁÇπÊ§úÂá∫Âá¶ÁêÜ
            function detectJoints(file) {
                loadingElement.style.display = 'block';
                errorMessage.style.display = 'none';
                
                const formData = new FormData();
                formData.append('image', file);
                
                fetch('/detect_joints', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    loadingElement.style.display = 'none';
                    if (data.success) {
                        jointPoints = data.joints;
                        renderJointPoints();
                        noAnalysisMessage.style.display = 'none';
                    } else {
                        showError(data.error || 'Èñ¢ÁØÄÊ§úÂá∫„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÂà•„ÅÆÁîªÂÉè„ÇíË©¶„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    loadingElement.style.display = 'none';
                    showError('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶Ë©¶„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                });
            }
            
            // Èñ¢ÁØÄÁÇπ„ÅÆÊèèÁîª
            function renderJointPoints() {
                // Êó¢Â≠ò„ÅÆÈñ¢ÁØÄÁÇπ„Çí„ÇØ„É™„Ç¢
                clearJointPoints();
                
                // ÁîªÂÉè„ÅÆÂÆüÈöõ„ÅÆ„Çµ„Ç§„Ç∫„ÇíÂèñÂæó
                const imgWidth = previewImage.clientWidth;
                const imgHeight = previewImage.clientHeight;
                
                // Èñ¢ÁØÄÁÇπ„ÅÆÊèèÁîª
                for (const key in jointPoints) {
                    const joint = jointPoints[key];
                    const jointElement = document.createElement('div');
                    jointElement.className = 'joint-point';
                    jointElement.id = `joint-${key}`;
                    jointElement.setAttribute('data-joint-id', key);
                    jointElement.setAttribute('title', jointNames[key] || `Èñ¢ÁØÄ ${key}`);
                    
                    // Ê≠£Ë¶èÂåñ„Åï„Çå„ÅüÂ∫ßÊ®ô„ÇíÂÆüÈöõ„ÅÆ‰ΩçÁΩÆ„Å´Â§âÊèõ
                    const x = joint.x * imgWidth;
                    const y = joint.y * imgHeight;
                    
                    jointElement.style.left = `${x}px`;
                    jointElement.style.top = `${y}px`;
                    
                    // ÈÅ∏Êäû„Åï„Çå„ÅüÈñ¢ÁØÄÁÇπ„ÇíÂº∑Ë™øË°®Á§∫
                    if (key === selectedJoint) {
                        jointElement.style.backgroundColor = 'blue';
                        jointElement.style.width = '16px';
                        jointElement.style.height = '16px';
                    }
                    
                    // Èñ¢ÁØÄÁï™Âè∑„ÅÆË°®Á§∫
                    const jointNumber = document.createElement('div');
                    jointNumber.className = 'joint-number';
                    jointNumber.textContent = key;
                    jointElement.appendChild(jointNumber);
                    
                    // „Éâ„É©„ÉÉ„Ç∞Ê©üËÉΩ„ÇíËøΩÂä†
                    addDragListeners(jointElement);
                    
                    imageContainer.appendChild(jointElement);
                }
                
                // Èñ¢ÁØÄÁÇπÈñì„ÅÆÁ∑ö„ÇíÊèèÁîª
                drawLines();
            }
            
            // „Éâ„É©„ÉÉ„Ç∞Ê©üËÉΩ„ÅÆËøΩÂä†
            function addDragListeners(element) {
                element.addEventListener('mousedown', startDrag);
                element.addEventListener('touchstart', startDrag, { passive: false });
                
                function startDrag(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    isDragging = true;
                    dragTarget = element;
                    
                    const jointId = element.getAttribute('data-joint-id');
                    selectJoint(jointId);
                    
                    if (e.type === 'mousedown') {
                        dragOffsetX = e.clientX - element.getBoundingClientRect().left;
                        dragOffsetY = e.clientY - element.getBoundingClientRect().top;
                    } else {
                        dragOffsetX = e.touches[0].clientX - element.getBoundingClientRect().left;
                        dragOffsetY = e.touches[0].clientY - element.getBoundingClientRect().top;
                    }
                    
                    // „Éâ„É©„ÉÉ„Ç∞‰∏≠„ÅÆ„Ç§„Éô„É≥„Éà
                    document.addEventListener('mousemove', dragMove);
                    document.addEventListener('touchmove', dragMove, { passive: false });
                    
                    // „Éâ„É©„ÉÉ„Ç∞ÁµÇ‰∫ÜÊôÇ„ÅÆ„Ç§„Éô„É≥„Éà
                    document.addEventListener('mouseup', stopDrag);
                    document.addEventListener('touchend', stopDrag);
                }
            }
            
            // „Éâ„É©„ÉÉ„Ç∞ÁßªÂãïÂá¶ÁêÜ
            function dragMove(e) {
                if (!isDragging || !dragTarget) return;
                e.preventDefault();
                
                let clientX, clientY;
                if (e.type === 'mousemove') {
                    clientX = e.clientX;
                    clientY = e.clientY;
                } else {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                }
                
                const containerRect = imageContainer.getBoundingClientRect();
                const imgRect = previewImage.getBoundingClientRect();
                
                // ÁîªÂÉèÂÜÖ„Åß„ÅÆ‰ΩçÁΩÆ„ÇíË®àÁÆó
                let x = clientX - containerRect.left - dragOffsetX;
                let y = clientY - containerRect.top - dragOffsetY;
                
                // ÁîªÂÉè„ÅÆÁØÑÂõ≤ÂÜÖ„Å´Âà∂Èôê
                x = Math.max(0, Math.min(x, imgRect.width));
                y = Math.max(0, Math.min(y, imgRect.height));
                
                // Ë¶ÅÁ¥†„ÅÆ‰ΩçÁΩÆ„ÇíÊõ¥Êñ∞
                dragTarget.style.left = `${x}px`;
                dragTarget.style.top = `${y}px`;
                
                // Èñ¢ÁØÄÁÇπ„Éá„Éº„Çø„ÇíÊõ¥Êñ∞
                const jointId = dragTarget.getAttribute('data-joint-id');
                jointPoints[jointId].x = x / imgRect.width;
                jointPoints[jointId].y = y / imgRect.height;
                
                // UI„ÅÆÊõ¥Êñ∞
                updateJointControlUI(jointId);
                
                // Á∑ö„ÅÆÊõ¥Êñ∞
                drawLines();
            }
            
            // „Éâ„É©„ÉÉ„Ç∞ÁµÇ‰∫ÜÂá¶ÁêÜ
            function stopDrag() {
                isDragging = false;
                dragTarget = null;
                
                document.removeEventListener('mousemove', dragMove);
                document.removeEventListener('touchmove', dragMove);
                document.removeEventListener('mouseup', stopDrag);
                document.removeEventListener('touchend', stopDrag);
            }
            
            // Èñ¢ÁØÄÁÇπÈñì„ÅÆÁ∑ö„ÇíÊèèÁîª
            function drawLines() {
                // Êó¢Â≠ò„ÅÆÁ∑ö„Çí„ÇØ„É™„Ç¢
                document.querySelectorAll('.joint-line').forEach(el => el.remove());
                
                const imgWidth = previewImage.clientWidth;
                const imgHeight = previewImage.clientHeight;
                
                // Èñ¢ÁØÄÁÇπ„ÅÆÊé•Á∂ö„ÇíÂÆöÁæ©
                const connections = [
                    ['1', '2'], // Èºª ‚Üí Âè≥ËÇ©
                    ['2', '3'], // Âè≥ËÇ© ‚Üí Âè≥ËÖ∞
                    ['3', '4'], // Âè≥ËÖ∞ ‚Üí Âè≥ËÜù
                    ['4', '6'], // Âè≥ËÜù ‚Üí Âè≥Ë∂≥È¶ñ
                    ['3', '5'], // Âè≥ËÖ∞ ‚Üí Â∑¶ËÜù
                    ['5', '7'], // Â∑¶ËÜù ‚Üí Â∑¶Ë∂≥È¶ñ
                    ['2', '10'], // Âè≥ËÇ© ‚Üí C7
                ];
                
                // C7„Åã„ÇâËÖ∞„Å∏„ÅÆÊé•Á∂öÔºàÈ£õ„Å≥Âá∫„ÅóÂàÜÊûêÁî®Ôºâ
                if (jointPoints['10'] && jointPoints['3']) {
                    connections.push(['10', '3']); // C7 ‚Üí Âè≥ËÖ∞
                }
                
                // Á∑ö„ÇíÊèèÁîª
                connections.forEach(conn => {
                    if (jointPoints[conn[0]] && jointPoints[conn[1]]) {
                        const start = {
                            x: jointPoints[conn[0]].x * imgWidth,
                            y: jointPoints[conn[0]].y * imgHeight
                        };
                        const end = {
                            x: jointPoints[conn[1]].x * imgWidth,
                            y: jointPoints[conn[1]].y * imgHeight
                        };
                        
                        // Á∑ö„ÅÆÈï∑„Åï„Å®ËßíÂ∫¶„ÇíË®àÁÆó
                        const length = Math.sqrt(Math.pow(end.x - start.x, 2) + Math.pow(end.y - start.y, 2));
                        const angle = Math.atan2(end.y - start.y, end.x - start.x) * 180 / Math.PI;
                        
                        // Á∑öË¶ÅÁ¥†„ÅÆ‰ΩúÊàê
                        const line = document.createElement('div');
                        line.className = 'joint-line';
                        line.style.width = `${length}px`;
                        line.style.left = `${start.x}px`;
                        line.style.top = `${start.y}px`;
                        line.style.transform = `rotate(${angle}deg)`;
                        
                        // C7„Åã„ÇâËÖ∞„Å∏„ÅÆÁ∑ö„ÅØÁâπÂà•„Å™Ëâ≤
                        if (conn[0] === '10' && conn[1] === '3') {
                            line.style.backgroundColor = 'purple';
                            line.style.height = '4px';
                        }
                        
                        imageContainer.appendChild(line);
                    }
                });
            }
            
            // Èñ¢ÁØÄÁÇπ„ÅÆÈÅ∏Êäû
            function selectJoint(jointId) {
                selectedJoint = jointId;
                
                // „Éó„É´„ÉÄ„Ç¶„É≥„ÅÆÂÄ§„ÇíÊõ¥Êñ∞
                if (dropdownJointSelector) {
                    dropdownJointSelector.value = jointId;
                }
                
                // „Çπ„É©„Ç§„ÉÄ„Éº„ÅÆÂÄ§„ÇíÊõ¥Êñ∞
                updateJointControlUI(jointId);
                
                // Èñ¢ÁØÄÁÇπ„ÅÆÊèèÁîª„ÇíÊõ¥Êñ∞
                renderJointPoints();
            }
            
            // Èñ¢ÁØÄÁÇπ„ÅÆ„Ç≥„É≥„Éà„É≠„Éº„É´UI„ÇíÊõ¥Êñ∞
            function updateJointControlUI(jointId) {
                if (!jointPoints[jointId]) return;
                
                const joint = jointPoints[jointId];
                
                // „Çπ„É©„Ç§„ÉÄ„Éº„ÅÆÂÄ§„ÇíÊõ¥Êñ∞
                jointXInput.value = Math.round(joint.x * 100);
                jointYInput.value = Math.round(joint.y * 100);
                jointXValue.textContent = `${Math.round(joint.x * 100)}%`;
                jointYValue.textContent = `${Math.round(joint.y * 100)}%`;
                
                // Ë™øÊï¥„Éë„Éç„É´„ÇíË°®Á§∫
                jointAdjustmentPanel.style.display = 'flex';
            }
            
            // Èñ¢ÁØÄÁÇπ„ÅÆ„ÇØ„É™„Ç¢
            function clearJointPoints() {
                document.querySelectorAll('.joint-point, .joint-line').forEach(el => el.remove());
            }
            
            // „Ç®„É©„ÉºË°®Á§∫
            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
            }
            
            // ÂßøÂã¢ÂàÜÊûêÔºà„Çª„ÉÉ„ÉàÂßøÂã¢Ôºâ
            analyzeSetBtn.addEventListener('click', function() {
                analyzePosture('set');
            });
            
            // ÂßøÂã¢ÂàÜÊûêÔºàÈ£õ„Å≥Âá∫„ÅóÔºâ
            analyzeStartBtn.addEventListener('click', function() {
                analyzePosture('start');
            });
            
            // ÂßøÂã¢ÂàÜÊûê„ÅÆÂÆüË°å
            function analyzePosture(mode) {
                if (Object.keys(jointPoints).length === 0) {
                    showError('Èñ¢ÁØÄÁÇπ„ÅåÊ§úÂá∫„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇÁîªÂÉè„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    return;
                }
                
                loadingElement.style.display = 'block';
                errorMessage.style.display = 'none';
                
                fetch('/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        joints: jointPoints,
                        mode: mode
                    })
                })
                .then(response => response.json())
                .then(data => {
                    loadingElement.style.display = 'none';
                    if (data.success) {
                        displayAnalysisResults(data.analysis, mode);
                    } else {
                        showError(data.error || 'ÂàÜÊûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶Ë©¶„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    loadingElement.style.display = 'none';
                    showError('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶Ë©¶„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                });
            }
            
            // ÂàÜÊûêÁµêÊûú„ÅÆË°®Á§∫
            function displayAnalysisResults(analysis, mode) {
                // „Çπ„Ç≥„Ç¢„ÇíË°®Á§∫
                scoreElement.textContent = analysis.score;
                
                // ËßíÂ∫¶ÊÉÖÂ†±„ÇíË°®Á§∫
                anglesContainer.innerHTML = '';
                
                if (mode === 'set') {
                    const angles = {
                        'ÂâçË∂≥ËÜùËßíÂ∫¶': analysis.angles.front_angle,
                        'ÂæåË∂≥ËÜùËßíÂ∫¶': analysis.angles.rear_angle,
                        'ÂâçË∂≥ËÇ°Èñ¢ÁØÄËßíÂ∫¶': analysis.angles.hip_angle
                    };
                    
                    for (const [key, value] of Object.entries(angles)) {
                        const angleElement = document.createElement('div');
                        angleElement.className = 'mb-2';
                        angleElement.innerHTML = `<strong>${key}:</strong> ${value}¬∞`;
                        anglesContainer.appendChild(angleElement);
                    }
                    
                    // „Ç∞„É©„Éï„ÅÆÊõ¥Êñ∞
                    updateAnglesChart(
                        ['ÂâçË∂≥ËÜùËßíÂ∫¶', 'ÂæåË∂≥ËÜùËßíÂ∫¶', 'ÂâçË∂≥ËÇ°Èñ¢ÁØÄËßíÂ∫¶'],
                        [analysis.angles.front_angle, analysis.angles.rear_angle, analysis.angles.hip_angle],
                        [90, 125, 50]
                    );
                } else {
                    const angles = {
                        '‰∏ãÂçäË∫´ËßíÂ∫¶': analysis.angles.lower_angle,
                        '‰∏äÂçäË∫´ËßíÂ∫¶': analysis.angles.upper_angle,
                        '„Åè„ÅÆÂ≠óËßíÂ∫¶': analysis.angles.kunoji_angle
                    };
                    
                    for (const [key, value] of Object.entries(angles)) {
                        const angleElement = document.createElement('div');
                        angleElement.className = 'mb-2';
                        angleElement.innerHTML = `<strong>${key}:</strong> ${value}¬∞`;
                        anglesContainer.appendChild(angleElement);
                    }
                    
                    // „Ç∞„É©„Éï„ÅÆÊõ¥Êñ∞
                    updateAnglesChart(
                        ['‰∏ãÂçäË∫´ËßíÂ∫¶', '‰∏äÂçäË∫´ËßíÂ∫¶', '„Åè„ÅÆÂ≠óËßíÂ∫¶'],
                        [analysis.angles.lower_angle, analysis.angles.upper_angle, analysis.angles.kunoji_angle],
                        [45, 40, 160]
                    );
                }
                
                // „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÇíË°®Á§∫
                feedbackContainer.innerHTML = '';
                analysis.feedback.forEach(feedback => {
                    const feedbackElement = document.createElement('div');
                    feedbackElement.className = 'feedback-item mb-2';
                    feedbackElement.textContent = feedback;
                    
                    // „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„Å´Âøú„Åò„Å¶Ëâ≤„ÇíÂ§âÊõ¥
                    if (feedback.includes('ÁêÜÊÉ≥ÁöÑ')) {
                        feedbackElement.style.backgroundColor = '#d1e7dd';
                    } else if (feedback.includes('Ëøë„Å•„Åë') || feedback.includes('ÊÑèË≠ò')) {
                        feedbackElement.style.backgroundColor = '#f8d7da';
                    }
                    
                    feedbackContainer.appendChild(feedbackElement);
                });
                
                // ÂàÜÊûêÁµêÊûú„ÇíË°®Á§∫
                analysisContainer.style.display = 'block';
                noAnalysisMessage.style.display = 'none';
            }
            
            // ËßíÂ∫¶„Ç∞„É©„Éï„ÅÆÊõ¥Êñ∞
            function updateAnglesChart(labels, values, idealValues) {
                const ctx = document.getElementById('angles-chart').getContext('2d');
                
                // Êó¢Â≠ò„ÅÆ„Ç∞„É©„Éï„ÇíÁ†¥Ê£Ñ
                if (anglesChart) {
                    anglesChart.destroy();
                }
                
                // Êñ∞„Åó„ÅÑ„Ç∞„É©„Éï„Çí‰ΩúÊàê
                anglesChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Ê∏¨ÂÆöÂÄ§',
                                data: values,
                                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'ÁêÜÊÉ≥ÂÄ§',
                                data: idealValues,
                                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 1,
                                type: 'line'
                            }
                        ]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: Math.max(...values, ...idealValues) * 1.2
                            }
                        },
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
            
            // „É¢„Éº„ÉâÂàáÊõø„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„ÉàË®≠ÂÆö
            modeButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„ÇØ„É©„Çπ„ÇíÂàá„ÇäÊõø„Åà
                    modeButtons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // „É¢„Éº„Éâ„ÇíÂàá„ÇäÊõø„Åà
                    currentMode = this.getAttribute('data-mode');
                    
                    // „Ç≥„É≥„Éà„É≠„Éº„É´„Éë„Éç„É´„ÅÆË°®Á§∫ÂàáÊõø
                    dropdownControls.style.display = currentMode === 'dropdown' ? 'block' : 'none';
                    horizontalControls.style.display = currentMode === 'horizontal' ? 'block' : 'none';
                });
            });
            
            // „Éó„É´„ÉÄ„Ç¶„É≥ÈÅ∏Êäû„Åó„ÅüÈñ¢ÁØÄÁÇπ„ÅÆË°®Á§∫„Éú„Çø„É≥
            showSelectedJointBtn.addEventListener('click', function() {
                const jointId = dropdownJointSelector.value;
                selectJoint(jointId);
            });
            
            // XÂ∫ßÊ®ô„Çπ„É©„Ç§„ÉÄ„Éº„ÅÆ„Ç§„Éô„É≥„Éà
            jointXInput.addEventListener('input', function() {
                if (!selectedJoint || !jointPoints[selectedJoint]) return;
                
                const value = parseInt(this.value) / 100;
                jointXValue.textContent = `${this.value}%`;
                
                jointPoints[selectedJoint].x = value;
                renderJointPoints();
            });
            
            // YÂ∫ßÊ®ô„Çπ„É©„Ç§„ÉÄ„Éº„ÅÆ„Ç§„Éô„É≥„Éà
            jointYInput.addEventListener('input', function() {
                if (!selectedJoint || !jointPoints[selectedJoint]) return;
                
                const value = parseInt(this.value) / 100;
                jointYValue.textContent = `${this.value}%`;
                
                jointPoints[selectedJoint].y = value;
                renderJointPoints();
            });
            
            // Ê®™‰∏¶„Å≥Ë°®Á§∫„É¢„Éº„Éâ„ÅÆÈñ¢ÁØÄÁÇπË™øÊï¥„Éú„Çø„É≥
            jointAdj
