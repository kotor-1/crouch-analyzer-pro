<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸƒ ã‚¯ãƒ©ã‚¦ãƒãƒ³ã‚°ã‚¹ã‚¿ãƒ³ã‚¹åˆ†æãƒ—ãƒ­</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .dropzone {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s;
        }
        .dropzone.highlight {
            border-color: #007bff;
            background-color: rgba(0,123,255,0.1);
        }
        .joint-point {
            position: absolute;
            width: 12px;
            height: 12px;
            background-color: red;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: move;
            z-index: 10;
            border: 2px solid white;
        }
        .joint-line {
            position: absolute;
            background-color: yellow;
            height: 2px;
            transform-origin: left center;
            z-index: 5;
        }
        .angle-text {
            position: absolute;
            color: white;
            background-color: rgba(0,0,0,0.6);
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 12px;
            z-index: 15;
        }
        .control-panel {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .image-container {
            position: relative;
            margin: 15px 0;
            max-width: 100%;
            overflow: hidden;
        }
        #preview-image {
            max-width: 100%;
            display: none;
        }
        .mode-selector .btn {
            margin-right: 5px;
            margin-bottom: 5px;
        }
        .analysis-container {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        .feedback-item {
            margin: 5px 0;
            padding: 8px;
            border-radius: 4px;
            background-color: #e9ecef;
        }
        .arrow-controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr 1fr;
            width: 120px;
            margin: 10px auto;
        }
        .arrow-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        footer {
            margin-top: 40px;
            padding: 20px 0;
            background-color: #f8f9fa;
            text-align: center;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">ğŸƒ ã‚¯ãƒ©ã‚¦ãƒãƒ³ã‚°ã‚¹ã‚¿ãƒ³ã‚¹åˆ†æãƒ—ãƒ­</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#helpModal">
                            <i class="bi bi-question-circle"></i> ä½¿ã„æ–¹
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="share-btn">
                            <i class="bi bi-share"></i> å…±æœ‰
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-lg-8">
                <!-- ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">ğŸ–¼ï¸ ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h5>
                    </div>
                    <div class="card-body">
                        <div class="dropzone" id="upload-dropzone">
                            <p class="mb-2">ç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</p>
                            <p>ã¾ãŸã¯</p>
                            <input type="file" id="image-upload" class="d-none" accept="image/*">
                            <button class="btn btn-primary" onclick="document.getElementById('image-upload').click()">
                                <i class="bi bi-upload"></i> ç”»åƒã‚’é¸æŠ
                            </button>
                        </div>
                        <div class="mt-2 text-center" id="loading" style="display:none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p>ğŸ¤– AIåˆ†æä¸­...</p>
                        </div>
                        <div class="alert alert-danger mt-3" id="error-message" style="display:none;"></div>
                    </div>
                </div>

                <!-- ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨é–¢ç¯€ç‚¹ç·¨é›†ã‚¨ãƒªã‚¢ -->
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">ğŸ“ å§¿å‹¢åˆ†æ</h5>
                    </div>
                    <div class="card-body">
                        <div class="image-container" id="image-container">
                            <img id="preview-image" alt="ã‚¯ãƒ©ã‚¦ãƒãƒ³ã‚°å§¿å‹¢">
                            <!-- é–¢ç¯€ç‚¹ã¨ãƒ©ã‚¤ãƒ³ã¯JSã§å‹•çš„ã«è¿½åŠ  -->
                        </div>

                        <!-- é–¢ç¯€ç‚¹ç·¨é›†ãƒ¢ãƒ¼ãƒ‰é¸æŠ -->
                        <div class="control-panel mt-3">
                            <h6>ğŸ”¢ é–¢ç¯€ç‚¹èª¿æ•´ãƒ¢ãƒ¼ãƒ‰:</h6>
                            <div class="mode-selector btn-group" role="group">
                                <button type="button" class="btn btn-outline-primary active" data-mode="click">
                                    â¶ ã‚¯ãƒªãƒƒã‚¯é¸æŠ
                                </button>
                                <button type="button" class="btn btn-outline-primary" data-mode="arrow">
                                    â· æ–¹å‘ã‚­ãƒ¼èª¿æ•´
                                </button>
                                <button type="button" class="btn btn-outline-primary" data-mode="dropdown">
                                    â¸ ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³é¸æŠ
                                </button>
                                <button type="button" class="btn btn-outline-primary" data-mode="all">
                                    â¹ ä¸€æ‹¬è¡¨ç¤º
                                </button>
                            </div>

                            <!-- æ–¹å‘ã‚­ãƒ¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« (ã‚¢ãƒ­ãƒ¼ãƒ¢ãƒ¼ãƒ‰ç”¨) -->
                            <div id="arrow-controls" class="mt-3" style="display:none;">
                                <div class="row">
                                    <div class="col-md-6">
                                        <select class="form-select mb-2" id="joint-selector">
                                            <option value="1">é ­éƒ¨</option>
                                            <option value="2">å³è‚©</option>
                                            <option value="3">å³è…°</option>
                                            <option value="4">å³è†</option>
                                            <option value="5">å·¦è†</option>
                                            <option value="6">å³è¶³é¦–</option>
                                            <option value="7">å·¦è¶³é¦–</option>
                                            <option value="8">å·¦æ‰‹é¦–</option>
                                            <option value="9">å³æ‰‹é¦–</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="arrow-controls">
                                            <button class="btn btn-sm btn-light arrow-btn" data-dir="nw">â†–</button>
                                            <button class="btn btn-sm btn-light arrow-btn" data-dir="n">â†‘</button>
                                            <button class="btn btn-sm btn-light arrow-btn" data-dir="ne">â†—</button>
                                            <button class="btn btn-sm btn-light arrow-btn" data-dir="w">â†</button>
                                            <button class="btn btn-sm btn-light arrow-btn" data-dir="c">â€¢</button>
                                            <button class="btn btn-sm btn-light arrow-btn" data-dir="e">â†’</button>
                                            <button class="btn btn-sm btn-light arrow-btn" data-dir="sw">â†™</button>
                                            <button class="btn btn-sm btn-light arrow-btn" data-dir="s">â†“</button>
                                            <button class="btn btn-sm btn-light arrow-btn" data-dir="se">â†˜</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³é¸æŠãƒ¢ãƒ¼ãƒ‰ç”¨ -->
                            <div id="dropdown-controls" class="mt-3" style="display:none;">
                                <div class="row">
                                    <div class="col-md-8">
                                        <select class="form-select" id="dropdown-joint-selector">
                                            <option value="1">é ­éƒ¨</option>
                                            <option value="2">å³è‚©</option>
                                            <option value="3">å³è…°</option>
                                            <option value="4">å³è†</option>
                                            <option value="5">å·¦è†</option>
                                            <option value="6">å³è¶³é¦–</option>
                                            <option value="7">å·¦è¶³é¦–</option>
                                            <option value="8">å·¦æ‰‹é¦–</option>
                                            <option value="9">å³æ‰‹é¦–</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <button class="btn btn-primary w-100" id="show-selected-joint">è¡¨ç¤º</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- åˆ†æãƒœã‚¿ãƒ³ -->
                        <div class="mt-3">
                            <div class="d-flex justify-content-between">
                                <div class="btn-group" role="group">
                                    <button class="btn btn-success" id="analyze-set-btn">
                                        ğŸƒ ã‚»ãƒƒãƒˆå§¿å‹¢åˆ†æ
                                    </button>
                                    <button class="btn btn-info text-white" id="analyze-start-btn">
                                        ğŸš€ é£›ã³å‡ºã—åˆ†æ
                                    </button>
                                </div>
                                <button class="btn btn-outline-secondary" id="download-btn">
                                    <i class="bi bi-download"></i> ç”»åƒä¿å­˜
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <!-- åˆ†æçµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">ğŸ“Š åˆ†æçµæœ</h5>
                    </div>
                    <div class="card-body">
                        <div class="analysis-container" id="analysis-container" style="display:none;">
                            <div class="text-center mb-3">
                                <h4>ã‚¹ã‚³ã‚¢: <span id="score" class="badge bg-success">0</span>/100</h4>
                            </div>
                            
                            <!-- è§’åº¦ã‚°ãƒ©ãƒ• -->
                            <div class="mb-4">
                                <h6>è§’åº¦åˆ†æ:</h6>
                                <canvas id="angles-chart" height="200"></canvas>
                            </div>
                            
                            <!-- è©³ç´°ãªè§’åº¦æƒ…å ± -->
                            <div class="mb-3" id="angles-container"></div>
                            
                            <!-- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ -->
                            <div>
                                <h6>ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯:</h6>
                                <div id="feedback-container"></div>
                            </div>
                        </div>
                        
                        <div class="text-center mt-3" id="no-analysis-message">
                            <p class="text-muted">ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦åˆ†æã‚’é–‹å§‹ã—ã¦ãã ã•ã„</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
    <footer class="mt-5">
        <div class="container">
            <p>ğŸ¯ ã‚¯ãƒ©ã‚¦ãƒãƒ³ã‚°ã‚¹ã‚¿ãƒ³ã‚¹åˆ†æãƒ—ãƒ­ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 1.0.0</p>
            <p>ğŸ“ é–‹ç™ºè€…: kotor-1 | ãƒ©ã‚¤ã‚»ãƒ³ã‚¹: MIT | æ›´æ–°æ—¥: 2025å¹´8æœˆ5æ—¥</p>
        </div>
    </footer>

    <!-- ãƒ˜ãƒ«ãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="helpModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h6>åŸºæœ¬æ“ä½œ</h6>
                    <ol>
                        <li>ç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã¾ãŸã¯é¸æŠã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</li>
                        <li>AIå§¿å‹¢æ¨å®šã«ã‚ˆã‚Šé–¢ç¯€ç‚¹ãŒè‡ªå‹•æ¤œå‡ºã•ã‚Œã¾ã™</li>
                        <li>4ã¤ã®èª¿æ•´ãƒ¢ãƒ¼ãƒ‰ã‹ã‚‰é¸ã‚“ã§é–¢ç¯€ç‚¹ã‚’èª¿æ•´ã§ãã¾ã™</li>
                        <li>ã€Œã‚»ãƒƒãƒˆå§¿å‹¢åˆ†æã€ã¾ãŸã¯ã€Œé£›ã³å‡ºã—åˆ†æã€ã‚’é¸æŠ</li>
                        <li>åˆ†æçµæœã‚’ç¢ºèªã—ã€å¿…è¦ã«å¿œã˜ã¦ç”»åƒã‚’ä¿å­˜</li>
                    </ol>
                    
                    <h6>é–¢ç¯€ç‚¹èª¿æ•´ãƒ¢ãƒ¼ãƒ‰</h6>
                    <ul>
                        <li><b>â¶ ã‚¯ãƒªãƒƒã‚¯é¸æŠ</b>: é–¢ç¯€ç‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠã—ã€ç”»åƒä¸Šã®ä»»æ„ã®å ´æ‰€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç§»å‹•</li>
                        <li><b>â· æ–¹å‘ã‚­ãƒ¼èª¿æ•´</b>: ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã§é–¢ç¯€ç‚¹ã‚’é¸ã³ã€æ–¹å‘ãƒœã‚¿ãƒ³ã§ç´°ã‹ãç§»å‹•</li>
                        <li><b>â¸ ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³é¸æŠ</b>: ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‹ã‚‰é–¢ç¯€ç‚¹ã‚’é¸æŠã—ã¦è¡¨ç¤ºãƒ»ç§»å‹•</li>
                        <li><b>â¹ ä¸€æ‹¬è¡¨ç¤º</b>: ã™ã¹ã¦ã®é–¢ç¯€ç‚¹ã‚’åŒæ™‚ã«è¡¨ç¤ºã—ã¦èª¿æ•´</li>
                    </ul>
                    
                    <h6>åˆ†æãƒ¢ãƒ¼ãƒ‰</h6>
                    <ul>
                        <li><b>ğŸƒ ã‚»ãƒƒãƒˆå§¿å‹¢åˆ†æ</b>: å‰è¶³è†è§’åº¦ã€å¾Œè¶³è†è§’åº¦ã€è‚¡é–¢ç¯€è§’åº¦ã‚’åˆ†æ</li>
                        <li><b>ğŸš€ é£›ã³å‡ºã—åˆ†æ</b>: ä¸‹åŠèº«è§’åº¦ã€ä¸ŠåŠèº«è§’åº¦ã€ãã®å­—è§’åº¦ã‚’åˆ†æ</li>
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å…±æœ‰ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="shareModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">åˆ†æçµæœã‚’å…±æœ‰</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>ä»¥ä¸‹ã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ã¨å…±æœ‰ã§ãã¾ã™:</p>
                    <div class="input-group">
                        <input type="text" class="form-control" id="share-url" readonly>
                        <button class="btn btn-outline-primary" type="button" id="copy-url-btn">ã‚³ãƒ”ãƒ¼</button>
                    </div>
                    <div class="mt-2" id="copy-success" style="display:none;">
                        <div class="alert alert-success">URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOMè¦ç´ ã®å‚ç…§ã‚’å–å¾—
            const imageUpload = document.getElementById('image-upload');
            const uploadDropzone = document.getElementById('upload-dropzone');
            const previewImage = document.getElementById('preview-image');
            const imageContainer = document.getElementById('image-container');
            const loadingElement = document.getElementById('loading');
            const errorMessage = document.getElementById('error-message');
            const analysisContainer = document.getElementById('analysis-container');
            const noAnalysisMessage = document.getElementById('no-analysis-message');
            const scoreElement = document.getElementById('score');
            const anglesContainer = document.getElementById('angles-container');
            const feedbackContainer = document.getElementById('feedback-container');
            const modeButtons = document.querySelectorAll('.mode-selector .btn');
            const arrowControls = document.getElementById('arrow-controls');
            const dropdownControls = document.getElementById('dropdown-controls');
            const jointSelector = document.getElementById('joint-selector');
            const downloadBtn = document.getElementById('download-btn');
            const analyzeSetBtn = document.getElementById('analyze-set-btn');
            const analyzeStartBtn = document.getElementById('analyze-start-btn');
            const shareBtn = document.getElementById('share-btn');
            const shareUrlInput = document.getElementById('share-url');
            const copyUrlBtn = document.getElementById('copy-url-btn');
            
            // å¤‰æ•°ã®åˆæœŸåŒ–
            let jointPoints = {};
            let selectedJoint = null;
            let currentMode = 'click';
            let anglesChart = null;
            
            // é–¢ç¯€ç‚¹ã®åå‰ãƒãƒƒãƒ”ãƒ³ã‚°
            const jointNames = {
                '1': 'é ­éƒ¨',
                '2': 'å³è‚©',
                '3': 'å³è…°',
                '4': 'å³è†',
                '5': 'å·¦è†',
                '6': 'å³è¶³é¦–',
                '7': 'å·¦è¶³é¦–',
                '8': 'å·¦æ‰‹é¦–',
                '9': 'å³æ‰‹é¦–'
            };
            
            // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†ã®è¨­å®š
            uploadDropzone.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('highlight');
            });
            
            uploadDropzone.addEventListener('dragleave', function() {
                this.classList.remove('highlight');
            });
            
            uploadDropzone.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('highlight');
                
                if (e.dataTransfer.files.length) {
                    handleImageUpload(e.dataTransfer.files[0]);
                }
            });
            
            // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå‡¦ç†
            imageUpload.addEventListener('change', function(e) {
                if (e.target.files.length) {
                    handleImageUpload(e.target.files[0]);
                }
            });
            
            // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
            function handleImageUpload(file) {
                if (!file || !file.type.match('image.*')) {
                    showError('ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ã€‚ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                
                // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®è¡¨ç¤º
                const reader = new FileReader();
                reader.onload = function(event) {
                    previewImage.src = event.target.result;
                    previewImage.style.display = 'block';
                    clearJointPoints();
                    detectJoints(file);
                };
                reader.readAsDataURL(file);
            }
            
            // é–¢ç¯€ç‚¹æ¤œå‡ºå‡¦ç†
            function detectJoints(file) {
                loadingElement.style.display = 'block';
                errorMessage.style.display = 'none';
                
                const formData = new FormData();
                formData.append('image', file);
                
                fetch('/detect_joints', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    loadingElement.style.display = 'none';
                    if (data.success) {
                        jointPoints = data.joints;
                        renderJointPoints();
                        noAnalysisMessage.style.display = 'none';
                    } else {
                        showError(data.error || 'é–¢ç¯€æ¤œå‡ºã«å¤±æ•—ã—ã¾ã—ãŸã€‚åˆ¥ã®ç”»åƒã‚’è©¦ã—ã¦ãã ã•ã„ã€‚');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    loadingElement.style.display = 'none';
                    showError('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ãã ã•ã„ã€‚');
                });
            }
            
            // é–¢ç¯€ç‚¹ã®æç”»
            function renderJointPoints() {
                // æ—¢å­˜ã®é–¢ç¯€ç‚¹ã‚’ã‚¯ãƒªã‚¢
                clearJointPoints();
                
                // ç”»åƒã®å®Ÿéš›ã®ã‚µã‚¤ã‚ºã‚’å–å¾—
                const imgWidth = previewImage.clientWidth;
                const imgHeight = previewImage.clientHeight;
                
                // è¡¨ç¤ºã™ã‚‹é–¢ç¯€ç‚¹ã‚’æ±ºå®šï¼ˆãƒ¢ãƒ¼ãƒ‰ã«åŸºã¥ãï¼‰
                let pointsToRender = {};
                
                if (currentMode === 'all') {
                    // å…¨ã¦ã®é–¢ç¯€ç‚¹ã‚’è¡¨ç¤º
                    pointsToRender = jointPoints;
                } else if (currentMode === 'dropdown' && selectedJoint) {
                    // é¸æŠã•ã‚ŒãŸé–¢ç¯€ç‚¹ã®ã¿è¡¨ç¤º
                    pointsToRender[selectedJoint] = jointPoints[selectedJoint];
                } else if (currentMode === 'click' || currentMode === 'arrow') {
                    // å…¨ã¦ã®é–¢ç¯€ç‚¹ã‚’è¡¨ç¤ºï¼ˆé¸æŠå¯èƒ½çŠ¶æ…‹ã§ï¼‰
                    pointsToRender = jointPoints;
                }
                
                // é–¢ç¯€ç‚¹ã‚’æç”»
                for (const key in pointsToRender) {
                    const joint = pointsToRender[key];
                    const jointElement = document.createElement('div');
                    jointElement.className = 'joint-point';
                    jointElement.id = `joint-${key}`;
                    jointElement.setAttribute('data-joint-id', key);
                    jointElement.setAttribute('title', jointNames[key] || `é–¢ç¯€ ${key}`);
                    
                    // æ­£è¦åŒ–ã•ã‚ŒãŸåº§æ¨™ã‚’å®Ÿéš›ã®ä½ç½®ã«å¤‰æ›
                    const x = joint.x * imgWidth;
                    const y = joint.y * imgHeight;
                    
                    jointElement.style.left = `${x}px`;
                    jointElement.style.top = `${y}px`;
                    
                    // é¸æŠã•ã‚ŒãŸé–¢ç¯€ç‚¹ã‚’å¼·èª¿è¡¨ç¤º
                    if (key === selectedJoint) {
                        jointElement.style.backgroundColor = 'blue';
                        jointElement.style.width = '16px';
                        jointElement.style.height = '16px';
                    }
                    
                    // ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½ã‚’è¿½åŠ 
                    makeJointDraggable(jointElement);
                    
                    // ã‚¯ãƒªãƒƒã‚¯é¸æŠãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
                    if (currentMode === 'click') {
                        jointElement.addEventListener('click', function(e) {
                            e.stopPropagation();
                            selectJoint(key);
                        });
                    }
                    
                    imageContainer.appendChild(jointElement);
                }
                
                // é–¢ç¯€ç‚¹é–“ã®ç·šã¨è§’åº¦ã®æç”»
                drawLinesAndAngles();
            }
            
            // é–¢ç¯€ç‚¹é–“ã®ç·šã¨è§’åº¦ã®æç”»
            function drawLinesAndAngles() {
                // æ—¢å­˜ã®ç·šã¨è§’åº¦è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
                document.querySelectorAll('.joint-line, .angle-text').forEach(el => el.remove());
                
                const imgWidth = previewImage.clientWidth;
                const imgHeight = previewImage.clientHeight;
                
                // ç·šã®æç”»ï¼ˆä¾‹: é ­-è‚©-è…°-è†-è¶³é¦–ï¼‰
                const connections = [
                    ['1', '2'], // é ­ â†’ è‚©
                    ['2', '3'], // è‚© â†’ è…°
                    ['3', '4'], // è…° â†’ å³è†
                    ['3', '5'], // è…° â†’ å·¦è†
                    ['4', '6'], // å³è† â†’ å³è¶³é¦–
                    ['5', '7']  // å·¦è† â†’ å·¦è¶³é¦–
                ];
                
                connections.forEach(conn => {
                    if (jointPoints[conn[0]] && jointPoints[conn[1]]) {
                        const start = {
                            x: jointPoints[conn[0]].x * imgWidth,
                            y: jointPoints[conn[0]].y * imgHeight
                        };
                        const end = {
                            x: jointPoints[conn[1]].x * imgWidth,
                            y: jointPoints[conn[1]].y * imgHeight
                        };
                        
                        // ç·šã®é•·ã•ã¨è§’åº¦ã‚’è¨ˆç®—
                        const length = Math.sqrt(Math.pow(end.x - start.x, 2) + Math.pow(end.y - start.y, 2));
                        const angle = Math.atan2(end.y - start.y, end.x - start.x) * 180 / Math.PI;
                        
                        // ç·šè¦ç´ ã®ä½œæˆ
                        const line = document.createElement('div');
                        line.className = 'joint-line';
                        line.style.width = `${length}px`;
                        line.style.left = `${start.x}px`;
                        line.style.top = `${start.y}px`;
                        line.style.transform = `rotate(${angle}deg)`;
                        
                        imageContainer.appendChild(line);
                    }
                });
                
                // è§’åº¦ã®è¨ˆç®—ã¨è¡¨ç¤ºï¼ˆä¾‹: è‚©-è…°-è†ã®è§’åº¦ï¼‰
                const angles = [
                    { name: 'ä¸ŠåŠèº«è§’åº¦', points: ['1', '2', '3'] }, // é ­-è‚©-è…°
                    { name: 'å³è†è§’åº¦', points: ['3', '4', '6'] },  // è…°-å³è†-å³è¶³é¦–
                    { name: 'å·¦è†è§’åº¦', points: ['3', '5', '7'] }   // è…°-å·¦è†-å·¦è¶³é¦–
                ];
                
                angles.forEach(angleData => {
                    const [p1, p2, p3] = angleData.points;
                    
                    if (jointPoints[p1] && jointPoints[p2] && jointPoints[p3]) {
                        const point1 = {
                            x: jointPoints[p1].x * imgWidth,
                            y: jointPoints[p1].y * imgHeight
                        };
                        const point2 = {
                            x: jointPoints[p2].x * imgWidth,
                            y: jointPoints[p2].y * imgHeight
                        };
                        const point3 = {
                            x: jointPoints[p3].x * imgWidth,
                            y: jointPoints[p3].y * imgHeight
                        };
                        
                        // è§’åº¦ã®è¨ˆç®—
                        const a = np_array([point1.x, point1.y]);
                        const b = np_array([point2.x, point2.y]);
                        const c = np_array([point3.x, point3.y]);
                        
                        const ba = array_subtract(a, b);
                        const bc = array_subtract(c, b);
                        
                        const cosine_angle = dot_product(ba, bc) / (norm(ba) * norm(bc));
                        const angle = Math.acos(Math.max(-1, Math.min(1, cosine_angle))) * 180 / Math.PI;
                        
                        // è§’åº¦è¡¨ç¤ºè¦ç´ ã®ä½œæˆ
                        const angleElement = document.createElement('div');
                        angleElement.className = 'angle-text';
                        angleElement.textContent = `${angle.toFixed(1)}Â°`;
                        angleElement.style.left = `${point2.x}px`;
                        angleElement.style.top = `${point2.y + 15}px`;
                        
                        imageContainer.appendChild(angleElement);
                    }
                });
            }
            
            // NumPyãƒ©ã‚¤ã‚¯ã®é–¢æ•°ã‚’å®Ÿè£…
            function np_array(arr) {
                return arr;
            }
            
            function array_subtract(a, b) {
                return [a[0] - b[0], a[1] - b[1]];
            }
            
            function dot_product(a, b) {
                return a[0] * b[0] + a[1] * b[1];
            }
            
            function norm(a) {
                return Math.sqrt(a[0] * a[0] + a[1] * a[1]);
            }
            
            // é–¢ç¯€ç‚¹ã®ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½
            function makeJointDraggable(element) {
                let isDragging = false;
                let offsetX, offsetY;
                
                element.addEventListener('mousedown', startDrag);
                element.addEventListener('touchstart', startDrag, { passive: false });
                
                function startDrag(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    isDragging = true;
                    
                    // é–¢ç¯€ç‚¹ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
                    if (currentMode === 'click' || currentMode === 'all') {
                        selectJoint(element.getAttribute('data-joint-id'));
                    }
                    
                    if (e.type === 'mousedown') {
                        offsetX = e.clientX - element.getBoundingClientRect().left;
                        offsetY = e.clientY - element.getBoundingClientRect().top;
                    } else {
                        offsetX = e.touches[0].clientX - element.getBoundingClientRect().left;
                        offsetY = e.touches[0].clientY - element.getBoundingClientRect().top;
                    }
                    
                    document.addEventListener('mousemove', dragMove);
                    document.addEventListener('touchmove', dragMove, { passive: false });
                    document.addEventListener('mouseup', stopDrag);
                    document.addEventListener('touchend', stopDrag);
                }
                
                function dragMove(e) {
                    if (!isDragging) return;
                    e.preventDefault();
                    
                    let clientX, clientY;
                    if (e.type === 'mousemove') {
                        clientX = e.clientX;
                        clientY = e.clientY;
                    } else {
                        clientX = e.touches[0].clientX;
                        clientY = e.touches[0].clientY;
                    }
                    
                    const containerRect = imageContainer.getBoundingClientRect();
                    const imgRect = previewImage.getBoundingClientRect();
                    
                    // ç”»åƒå†…ã§ã®ä½ç½®ã‚’è¨ˆç®—
                    let x = clientX - containerRect.left - offsetX;
                    let y = clientY - containerRect.top - offsetY;
                    
                    // ç”»åƒã®ç¯„å›²å†…ã«åˆ¶é™
                    x = Math.max(0, Math.min(x, imgRect.width));
                    y = Math.max(0, Math.min(y, imgRect.height));
                    
                    // è¦ç´ ã®ä½ç½®ã‚’æ›´æ–°
                    element.style.left = `${x}px`;
                    element.style.top = `${y}px`;
                    
                    // é–¢ç¯€ç‚¹ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
                    const jointId = element.getAttribute('data-joint-id');
                    jointPoints[jointId] = {
                        x: x / imgRect.width,
                        y: y / imgRect.height
                    };
                    
                    // ç·šã¨è§’åº¦ã‚’æ›´æ–°
                    drawLinesAndAngles();
                }
                
                function stopDrag() {
                    isDragging = false;
                    document.removeEventListener('mousemove', dragMove);
                    document.removeEventListener('touchmove', dragMove);
                    document.removeEventListener('mouseup', stopDrag);
                    document.removeEventListener('touchend', stopDrag);
                }
            }
            
            // é–¢ç¯€ç‚¹ã®é¸æŠ
            function selectJoint(jointId) {
                selectedJoint = jointId;
                
                // é–¢ç¯€ç‚¹ã‚»ãƒ¬ã‚¯ã‚¿ã®å€¤ã‚’æ›´æ–°
                if (jointSelector) {
                    jointSelector.value = jointId;
                }
                
                // é–¢ç¯€ç‚¹ã®æç”»ã‚’æ›´æ–°
                renderJointPoints();
            }
            
            // é–¢ç¯€ç‚¹ã®ã‚¯ãƒªã‚¢
            function clearJointPoints() {
                document.querySelectorAll('.joint-point, .joint-line, .angle-text').forEach(el => el.remove());
            }
            
            // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
            }
            
            // å§¿å‹¢åˆ†æï¼ˆã‚»ãƒƒãƒˆå§¿å‹¢ï¼‰
            analyzeSetBtn.addEventListener('click', function() {
                analyzePosture('set');
            });
            
            // å§¿å‹¢åˆ†æï¼ˆé£›ã³å‡ºã—ï¼‰
            analyzeStartBtn.addEventListener('click', function() {
                analyzePosture('start');
            });
            
            // å§¿å‹¢åˆ†æã®å®Ÿè¡Œ
            function analyzePosture(mode) {
                if (Object.keys(jointPoints).length === 0) {
                    showError('é–¢ç¯€ç‚¹ãŒæ¤œå‡ºã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                
                loadingElement.style.display = 'block';
                errorMessage.style.display = 'none';
                
                fetch('/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        joints: jointPoints,
                        mode: mode
                    })
                })
                .then(response => response.json())
                .then(data => {
                    loadingElement.style.display = 'none';
                    if (data.success) {
                        displayAnalysisResults(data.analysis, mode);
                    } else {
                        showError(data.error || 'åˆ†æã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ãã ã•ã„ã€‚');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    loadingElement.style.display = 'none';
                    showError('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ãã ã•ã„ã€‚');
                });
            }
            
            // åˆ†æçµæœã®è¡¨ç¤º
            function displayAnalysisResults(analysis, mode) {
                // ã‚¹ã‚³ã‚¢ã‚’è¡¨ç¤º
                scoreElement.textContent = analysis.score;
                
                // è§’åº¦æƒ…å ±ã‚’è¡¨ç¤º
                anglesContainer.innerHTML = '';
                for (const [key, value] of Object.entries(analysis.angles)) {
                    const angleElement = document.createElement('div');
                    angleElement.className = 'mb-2';
                    
                    // è§’åº¦åã®ãƒãƒƒãƒ”ãƒ³ã‚°
                    let angleName = key;
                    if (mode === 'set') {
                        if (key === 'back_angle') angleName = 'ä¸ŠåŠèº«è§’åº¦';
                        else if (key === 'knee_angle') angleName = 'å‰è¶³è†è§’åº¦';
                        else if (key === 'ankle_angle') angleName = 'å¾Œè¶³è†è§’åº¦';
                    } else {
                        if (key === 'back_angle') angleName = 'ä¸ŠåŠèº«è§’åº¦';
                        else if (key === 'knee_angle') angleName = 'ä¸‹åŠèº«è§’åº¦';
                        else if (key === 'ankle_angle') angleName = 'ãã®å­—è§’åº¦';
                    }
                    
                    angleElement.innerHTML = `<strong>${angleName}:</strong> ${value}Â°`;
                    anglesContainer.appendChild(angleElement);
                }
                
                // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è¡¨ç¤º
                feedbackContainer.innerHTML = '';
                analysis.feedback.forEach(feedback => {
                    const feedbackElement = document.createElement('div');
                    feedbackElement.className = 'feedback-item mb-2';
                    feedbackElement.textContent = feedback;
                    feedbackContainer.appendChild(feedbackElement);
                });
                
                // ã‚°ãƒ©ãƒ•ã®æ›´æ–°
                updateAnglesChart(analysis.angles, mode);
                
                // åˆ†æçµæœã‚’è¡¨ç¤º
                analysisContainer.style.display = 'block';
                noAnalysisMessage.style.display = 'none';
            }
            
            // è§’åº¦ã‚°ãƒ©ãƒ•ã®æ›´æ–°
            function updateAnglesChart(angles, mode) {
                const ctx = document.getElementById('angles-chart').getContext('2d');
                
                // ã‚°ãƒ©ãƒ•ã®ãƒ©ãƒ™ãƒ«ã¨ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
                let labels = [];
                let data = [];
                let idealValues = [];
                
                if (mode === 'set') {
                    labels = ['ä¸ŠåŠèº«è§’åº¦', 'å‰è¶³è†è§’åº¦', 'å¾Œè¶³è†è§’åº¦'];
                    data = [
                        angles.back_angle || 0,
                        angles.knee_angle || 0,
                        angles.ankle_angle || 0
                    ];
                    idealValues = [45, 90, 85]; // ç†æƒ³çš„ãªå€¤
                } else {
                    labels = ['ä¸ŠåŠèº«è§’åº¦', 'ä¸‹åŠèº«è§’åº¦', 'ãã®å­—è§’åº¦'];
                    data = [
                        angles.back_angle || 0,
                        angles.knee_angle || 0,
                        angles.ankle_angle || 0
                    ];
                    idealValues = [40, 110, 150]; // ç†æƒ³çš„ãªå€¤
                }
                
                // æ—¢å­˜ã®ã‚°ãƒ©ãƒ•ã‚’ç ´æ£„
                if (anglesChart) {
                    anglesChart.destroy();
                }
                
                // æ–°ã—ã„ã‚°ãƒ©ãƒ•ã‚’ä½œæˆ
                anglesChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'ç¾åœ¨ã®è§’åº¦',
                                data: data,
                                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'ç†æƒ³çš„ãªè§’åº¦',
                                data: idealValues,
                                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 1,
                                type: 'line'
                            }
                        ]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 180
                            }
                        },
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
            
            // ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
            modeButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¯ãƒ©ã‚¹ã‚’åˆ‡ã‚Šæ›¿ãˆ
                    modeButtons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // ãƒ¢ãƒ¼ãƒ‰ã‚’åˆ‡ã‚Šæ›¿ãˆ
                    currentMode = this.getAttribute('data-mode');
                    
                    // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ«ã®è¡¨ç¤ºåˆ‡æ›¿
                    arrowControls.style.display = currentMode === 'arrow' ? 'block' : 'none';
                    dropdownControls.style.display = currentMode === 'dropdown' ? 'block' : 'none';
                    
                    // é–¢ç¯€ç‚¹ã®è¡¨ç¤ºã‚’æ›´æ–°
                    renderJointPoints();
                });
            });
            
            // æ–¹å‘ã‚­ãƒ¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
            document.querySelectorAll('.arrow-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (!selectedJoint || !jointPoints[selectedJoint]) return;
                    
                    const dir = this.getAttribute('data-dir');
                    const imgWidth = previewImage.clientWidth;
                    const imgHeight = previewImage.clientHeight;
                    const step = 0.005; // ç§»å‹•ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚µã‚¤ã‚º
                    
                    let dx = 0, dy = 0;
                    
                    // æ–¹å‘ã«åŸºã¥ã„ã¦ç§»å‹•é‡ã‚’è¨­å®š
                    switch (dir) {
                        case 'n': dy = -step; break;
                        case 's': dy = step; break;
                        case 'e': dx = step; break;
                        case 'w': dx = -step; break;
                        case 'ne': dx = step; dy = -step; break;
                        case 'nw': dx = -step; dy = -step; break;
                        case 'se': dx = step; dy = step; break;
                        case 'sw': dx = -step; dy = step; break;
                        case 'c': break; // ä¸­å¤®ãƒœã‚¿ãƒ³ã¯ç§»å‹•ãªã—
                    }
                    
                    // é–¢ç¯€ç‚¹ã®ä½ç½®ã‚’æ›´æ–°
                    jointPoints[selectedJoint].x = Math.max(0, Math.min(1, jointPoints[selectedJoint].x + dx));
                    jointPoints[selectedJoint].y = Math.max(0, Math.min(1, jointPoints[selectedJoint].y + dy));
                    
                    // é–¢ç¯€ç‚¹ã®è¡¨ç¤ºã‚’æ›´æ–°
                    renderJointPoints();
                });
            });
            
            // ã‚¸ãƒ§ã‚¤ãƒ³ãƒˆã‚»ãƒ¬ã‚¯ã‚¿ã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
            if (jointSelector) {
                jointSelector.addEventListener('change', function() {
                    selectJoint(this.value);
                });
            }
            
            // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³é¸æŠãƒ¢ãƒ¼ãƒ‰ã®ã‚¸ãƒ§ã‚¤ãƒ³ãƒˆè¡¨ç¤ºãƒœã‚¿ãƒ³
            document.getElementById('show-selected-joint').addEventListener('click', function() {
                const selectedValue = document.getElementById('dropdown-joint-selector').value;
                selectJoint(selectedValue);
            });
            
            // ç”»åƒã‚¯ãƒªãƒƒã‚¯ã§é–¢ç¯€ç‚¹ã‚’é…ç½®ï¼ˆã‚¯ãƒªãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ï¼‰
            imageContainer.addEventListener('click', function(e) {
                if (currentMode !== 'click' || !selectedJoint) return;
                
                const rect = imageContainer.getBoundingClientRect();
                const imgRect = previewImage.getBoundingClientRect();
                
                // ã‚¯ãƒªãƒƒã‚¯ä½ç½®ã‚’è¨ˆç®—
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // ç”»åƒå†…ã®ç›¸å¯¾ä½ç½®ã«å¤‰æ›
                const relX = x / imgRect.width;
                const relY = y / imgRect.height;
                
                // é–¢ç¯€ç‚¹ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
                jointPoints[selectedJoint] = { x: relX, y: relY };
                
                // é–¢ç¯€ç‚¹ã‚’å†æç”»
                renderJointPoints();
            });
            
            // ç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
            downloadBtn.addEventListener('click', function() {
                if (!previewImage.src) {
                    showError('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                    return;
                }
                
                // Canvasè¦ç´ ã‚’ä½œæˆã—ã€ç”»åƒã¨é–¢ç¯€ç‚¹ãƒ»ç·šã‚’æç”»
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // ç”»åƒã®ã‚µã‚¤ã‚ºã«åˆã‚ã›ã‚‹
                canvas.width = previewImage.naturalWidth;
                canvas.height = previewImage.naturalHeight;
                
                // ç”»åƒã‚’æç”»
                const img = new Image();
                img.onload = function() {
                    ctx.drawImage(img, 0, 0);
                    
                    // é–¢ç¯€ç‚¹ã¨ç·šã‚’æç”»ï¼ˆã‚¹ã‚±ãƒ¼ãƒ«ã‚’èª¿æ•´ï¼‰
                    const scaleX = img.naturalWidth / previewImage.clientWidth;
                    const scaleY = img.naturalHeight / previewImage.clientHeight;
                    
                    // ç·šã‚’æç”»
                    document.querySelectorAll('.joint-line').forEach(line => {
                        const left = parseFloat(line.style.left) * scaleX;
                        const top = parseFloat(line.style.top) * scaleY;
                        const width = parseFloat(line.style.width) * scaleX;
                        const transform = line.style.transform;
                        const angle = parseFloat(transform.replace('rotate(', '').replace('deg)', ''));
                        
                        ctx.save();
                        ctx.translate(left, top);
                        ctx.rotate(angle * Math.PI / 180);
                        ctx.fillStyle = 'yellow';
                        ctx.fillRect(0, -1 * scaleY, width, 2 * scaleY);
                        ctx.restore();
                    });
                    
                    // é–¢ç¯€ç‚¹ã‚’æç”»
                    document.querySelectorAll('.joint-point').forEach(point => {
                        const left = parseFloat(point.style.left) * scaleX;
                        const top = parseFloat(point.style.top) * scaleY;
                        const radius = 6 * scaleX;
                        
                        ctx.beginPath();
                        ctx.arc(left, top, radius, 0, 2 * Math.PI);
                        ctx.fillStyle = 'red';
                        ctx.fill();
                        ctx.strokeStyle = 'white';
                        ctx.lineWidth = 2;
                        ctx.stroke();
                    });
                    
                    // è§’åº¦ãƒ†ã‚­ã‚¹ãƒˆã‚’æç”»
                    document.querySelectorAll('.angle-text').forEach(text => {
                        const left = parseFloat(text.style.left) * scaleX;
                        const top = parseFloat(text.style.top) * scaleY;
                        
                        ctx.font = `${12 * scaleX}px Arial`;
                        ctx.fillStyle = 'white';
                        ctx.strokeStyle = 'black';
                        ctx.lineWidth = 3;
                        ctx.strokeText(text.textContent, left, top);
                        ctx.fillText(text.textContent, left, top);
                    });
                    
                
